<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- 添加全局禁用 Referer -->
      <meta name="referrer" content="no-referrer" />
      <meta charset="utf-8" />
       
      <meta name="keywords" content="技术,编程,开发,Hexo" />
       
      <meta name="description" content="个人技术博客，分享编程、开发经验和生活感悟" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> Gavin&#39;s Blog</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
      <!-- Font Awesome 6 -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer" />
    <link rel="alternate" href="/atom.xml" title="Gavin's Blog" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/Shen-Yu/hexo-theme-ayer"
        target="_blank"><img width="149" height="149" src="/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Gavin&#39;s Blog</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['面朝大海，春暖花开', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  

<div class="notice" style="margin-top:50px">
    <i class="ri-heart-fill"></i>
    <div class="notice-content" id="broad"></div>
</div>
<script type="text/javascript">
    fetch('https://v1.hitokoto.cn')
        .then(response => response.json())
        .then(data => {
            document.getElementById("broad").innerHTML = data.hitokoto;
        })
        .catch(console.error)
</script>

<style>
    .notice {
        padding: 20px;
        border: 1px dashed #e6e6e6;
        color: #969696;
        position: relative;
        display: inline-block;
        width: 100%;
        background: #fbfbfb50;
        border-radius: 10px;
    }

    .notice i {
        float: left;
        color: #999;
        font-size: 16px;
        padding-right: 10px;
        vertical-align: middle;
        margin-top: -2px;
    }

    .notice-content {
        display: initial;
        vertical-align: middle;
    }
</style>
  
  <article class="articles">
    
    
    
    
    <article
  id="[layout]-iOS-发布代码到cocoapods上详细步骤"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2025/06/18/iOS-%E5%8F%91%E5%B8%83%E4%BB%A3%E7%A0%81%E5%88%B0cocoapods%E4%B8%8A%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/"
    >iOS-发布代码到cocoapods上详细步骤</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/06/18/iOS-%E5%8F%91%E5%B8%83%E4%BB%A3%E7%A0%81%E5%88%B0cocoapods%E4%B8%8A%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/" class="article-date">
  <time datetime="2025-06-18T07:55:07.000Z" itemprop="datePublished">2025-06-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="完整步骤："><a href="#完整步骤：" class="headerlink" title="完整步骤："></a>完整步骤：</h2><blockquote>
<ol>
<li><p>把你需要发布到CocoaPods的代码写好。</p>
</li>
<li><p>用Xcode创建一个Framework项目，将你写好的代码拖入Framework，进行相关配置，根据需求打包Framework。</p>
</li>
<li><p>注册CocoaPods账号，检查库名是否已被占用，没有被占用就创建Podspec文件，拖入通用Framework。</p>
</li>
<li><p>创建git仓库，修改xxx.podspec配置，将代码推送到远程仓库并进行版本控制，验证Podspec文件。</p>
</li>
<li><p>验证通过，发布到 CocoaPods。</p>
</li>
</ol>
</blockquote>
<h2 id="1-创建Framework项目"><a href="#1-创建Framework项目" class="headerlink" title="1. 创建Framework项目"></a>1. 创建Framework项目</h2><p><strong>1. 在Xcode中，选择File -&gt; New -&gt; Project</strong></p>
<p><strong>2. 选择iOS -&gt; Framework &amp; Library -&gt; Framework，然后点击Next</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-be0160ff8d3afd2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建Framework"></p>
<p><strong>3. 输入产品名称（例如：<code>LanguageSet</code>），选择语言（Objective-C或Swift），点击Next并保存。</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-83b4887d1f953d7e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建cocoapodsDemo"></p>
<h2 id="2-配置Framework"><a href="#2-配置Framework" class="headerlink" title="2. 配置Framework"></a>2. 配置Framework</h2><ul>
<li><strong>添加代码文件</strong>：将你的源代码文件拖入项目，确保在Build Phases -&gt; Headers中设置好公开头文件（Public Headers）。</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-ae2a853b2b80c1ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="添加代码文件"></p>
<ul>
<li><strong>将需要公开的头文件拖到public：</strong></li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-d9a8a7555487533e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="设置好公开头文件"></p>
<p><strong>添加第三方库</strong></p>
<blockquote>
<p>1.使用cocoapod是可以自动管理第三方库，在Link Binary With Libraries 中找到Pod_的framwork 选择Optional</p>
</blockquote>
<blockquote>
<p>2.手动添加第三方库和文件时，不要选择target</p>
</blockquote>
<ul>
<li><p><strong>设置Build Settings</strong>:</p>
</li>
<li><p><strong>Mach-O Type</strong>: 默认为Dynamic Library，也可以选择Static Library（但Framework通常指动态库）。<br><img src="https://upload-images.jianshu.io/upload_images/1976231-4ec8c2a6b6993b23.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Mach-O Type"></p>
</li>
<li><p><strong>Build Active Architecture Only</strong>: 设置为NO，以支持所有架构。<br><img src="https://upload-images.jianshu.io/upload_images/1976231-c68f41b1eae65414.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Build Active Architecture Only"></p>
</li>
<li><p><strong>iOS Deployment Target</strong>: 选择你希望支持的最低iOS版本。<br><img src="https://upload-images.jianshu.io/upload_images/1976231-7f6fb03188cbd741.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iOS Deployment Target"></p>
</li>
<li><p><strong>Swift版本</strong>：如果是Swift项目，确保设置正确的Swift版本。</p>
</li>
<li><p><strong>Enable Bitcode</strong>: 如果需要，设置为YES。</p>
</li>
</ul>
<h2 id="3-打包Framework（支持真机和模拟器）"><a href="#3-打包Framework（支持真机和模拟器）" class="headerlink" title="3. 打包Framework（支持真机和模拟器）"></a>3. 打包Framework（支持真机和模拟器）</h2><blockquote>
<p>我们需要同时支持真机和模拟器架构（arm64, x86_64），并最终合并为一个通用Framework。</p>
</blockquote>
<p><strong>1. 分别编译真机和模拟器版本</strong></p>
<p><strong>1. 真机Release</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild archive </span><br><span class="line"></span><br><span class="line">-scheme LanguageSet </span><br><span class="line"></span><br><span class="line">-configuration Release </span><br><span class="line"></span><br><span class="line">-destination &quot;generic/platform=iOS&quot; </span><br><span class="line"></span><br><span class="line">-archivePath &quot;build/LanguageSet-iOS&quot; </span><br><span class="line"></span><br><span class="line">SKIP_INSTALL=NO </span><br><span class="line"></span><br><span class="line">BUILD_LIBRARY_FOR_DISTRIBUTION=YES</span><br></pre></td></tr></table></figure>

<p><strong>2. 模拟器Release</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild archive </span><br><span class="line"></span><br><span class="line">-scheme LanguageSet </span><br><span class="line"></span><br><span class="line">-configuration Release </span><br><span class="line"></span><br><span class="line">-destination &quot;generic/platform=iOS Simulator&quot; </span><br><span class="line"></span><br><span class="line">-archivePath &quot;build/LanguageSet-Simulator&quot; </span><br><span class="line"></span><br><span class="line">SKIP_INSTALL=NO </span><br><span class="line"></span><br><span class="line">BUILD_LIBRARY_FOR_DISTRIBUTION=YES</span><br></pre></td></tr></table></figure>

<p><strong>2. 合并两个Framework-打包通用Framework（支持真机+模拟器）</strong></p>
<blockquote>
<p>使用<code>lipo</code>工具合并二进制文件，并复制模拟器的swiftmodule（如果有）到真机Framework中。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建通用Framework目录</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p build/LanguageSet-Universal</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制真机Framework到通用目录</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -R build/LanguageSet-iOS.xcarchive/Products/Library/Frameworks/LanguageSet build/LanguageSet-Universal/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并二进制文件</span></span><br><span class="line"></span><br><span class="line">lipo -create </span><br><span class="line"></span><br><span class="line">build/LanguageSet-iOS.xcarchive/Products/Library/Frameworks/LanguageSet.framework/LanguageSet </span><br><span class="line"></span><br><span class="line">build/LanguageSet-Simulator.xcarchive/Products/Library/Frameworks/LanguageSetframework/LanguageSet </span><br><span class="line"></span><br><span class="line">-output build/LanguageSet-Universal/LanguageSet.framework/LanguageSet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用Swift，需要合并swiftmodule</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;build/LanguageSet-Simulator.xcarchive/Products/Library/Frameworks/LanguageSet.framework/Modules/LanguageSet.swiftmodule&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -R build/LanguageSet-Simulator.xcarchive/Products/Library/Frameworks/LanguageSet.framework/Modules/LanguageSet.swiftmodule/* \</span><br><span class="line"></span><br><span class="line">build/LanguageSet-Universal/LanguageSet.framework/Modules/LanguageSet.swiftmodule/</span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>将上面的合并起来：</strong></p>
<p><strong>创建一个打包脚本 build_framework.sh</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 1. 定义基础变量</span><br><span class="line">SCHEME_NAME=&quot;LanguageSet&quot;   # 替换为实际Scheme名</span><br><span class="line">PROJECT_NAME=&quot;LanguageSet&quot;    # 替换为实际工程名</span><br><span class="line">CONFIGURATION=&quot;Release&quot;           # 建议使用Release模式</span><br><span class="line">OUTPUT_DIR=&quot;$&#123;PWD&#125;/Output&quot;        # 输出目录</span><br><span class="line"></span><br><span class="line"># 2. 清理旧构建</span><br><span class="line">rm -rf &quot;$&#123;OUTPUT_DIR&#125;&quot;</span><br><span class="line">mkdir -p &quot;$&#123;OUTPUT_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 3. 编译真机版本 (arm64, armv7)</span><br><span class="line">xcodebuild archive \</span><br><span class="line">  -project &quot;$&#123;PROJECT_NAME&#125;.xcodeproj&quot; \</span><br><span class="line">  -scheme &quot;$&#123;SCHEME_NAME&#125;&quot; \</span><br><span class="line">  -configuration &quot;$&#123;CONFIGURATION&#125;&quot; \</span><br><span class="line">  -sdk iphoneos \</span><br><span class="line">  -archivePath &quot;$&#123;OUTPUT_DIR&#125;/iphoneos.xcarchive&quot; \</span><br><span class="line">  SKIP_INSTALL=NO \</span><br><span class="line">  BUILD_LIBRARIES_FOR_DISTRIBUTION=YES  # 支持多架构 [[6]]</span><br><span class="line"></span><br><span class="line"># 4. 编译模拟器版本 (x86_64, arm64)</span><br><span class="line">xcodebuild archive \</span><br><span class="line">  -project &quot;$&#123;PROJECT_NAME&#125;.xcodeproj&quot; \</span><br><span class="line">  -scheme &quot;$&#123;SCHEME_NAME&#125;&quot; \</span><br><span class="line">  -configuration &quot;$&#123;CONFIGURATION&#125;&quot; \</span><br><span class="line">  -sdk iphonesimulator \</span><br><span class="line">  -archivePath &quot;$&#123;OUTPUT_DIR&#125;/iphonesimulator.xcarchive&quot; \</span><br><span class="line">  SKIP_INSTALL=NO \</span><br><span class="line">  BUILD_LIBRARIES_FOR_DISTRIBUTION=YES  # M1芯片需包含arm64 [[3, 6]]</span><br><span class="line"></span><br><span class="line"># 5. 合并为XCFramework (官方推荐方式)</span><br><span class="line">xcodebuild -create-xcframework \</span><br><span class="line">  -framework &quot;$&#123;OUTPUT_DIR&#125;/iphoneos.xcarchive/Products/Library/Frameworks/$&#123;SCHEME_NAME&#125;.framework&quot; \</span><br><span class="line">  -framework &quot;$&#123;OUTPUT_DIR&#125;/iphonesimulator.xcarchive/Products/Library/Frameworks/$&#123;SCHEME_NAME&#125;.framework&quot; \</span><br><span class="line">  -output &quot;$&#123;OUTPUT_DIR&#125;/$&#123;SCHEME_NAME&#125;.xcframework&quot;  # 生成多平台兼容包 [[2, 6, 12, 16]]</span><br><span class="line"></span><br><span class="line"># 6. 可选：生成Fat Framework (传统合并方式)</span><br><span class="line"># lipo -create \</span><br><span class="line">#   &quot;$&#123;OUTPUT_DIR&#125;/iphoneos.xcarchive/Products/Library/Frameworks/$&#123;SCHEME_NAME&#125;.framework/$&#123;SCHEME_NAME&#125;&quot; \</span><br><span class="line">#   &quot;$&#123;OUTPUT_DIR&#125;/iphonesimulator.xcarchive/Products/Library/Frameworks/$&#123;SCHEME_NAME&#125;.framework/$&#123;SCHEME_NAME&#125;&quot; \</span><br><span class="line">#   -output &quot;$&#123;OUTPUT_DIR&#125;/$&#123;SCHEME_NAME&#125;.framework/$&#123;SCHEME_NAME&#125;&quot;  # 需手动处理头文件 [[11, 15, 20]]</span><br><span class="line"></span><br><span class="line"># 7. 打开输出目录</span><br><span class="line">open &quot;$&#123;OUTPUT_DIR&#125;&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1976231-909a8b6bfe8a86bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="build_framework.sh 存放"></p>
<p><strong>运行脚本</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x build_framework.sh</span><br><span class="line">./build_framework.sh</span><br></pre></td></tr></table></figure>

<p><strong>生成文件夹：</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-b9c853f304e38d24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="XCFramework"></p>
<h2 id="注册CocoaPods的Trunk"><a href="#注册CocoaPods的Trunk" class="headerlink" title="注册CocoaPods的Trunk"></a>注册CocoaPods的Trunk</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 注册CocoaPods账号（仅首次）</span><br><span class="line">pod trunk register your-email@example.com &quot;Your Name&quot; --description=&#x27;MacBook Pro&#x27;</span><br></pre></td></tr></table></figure>

<p><code>CocoaPods会向你提供的邮箱发送一个验证链接，点击链接完成验证。 </code></p>
<p><strong>验证CocoaPods的Trunk注册结果</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod trunk me</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1976231-a69e3e9f4000afde.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Trunk创建验证"></p>
<h2 id="创建Podspec文件"><a href="#创建Podspec文件" class="headerlink" title="创建Podspec文件"></a>创建Podspec文件</h2><blockquote>
<p> <strong>pod lib create LanguageSet</strong></p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-e39b370605e72821.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建Podspec文件"></p>
<p><strong>生成Podspec文件夹</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-086200ce38c70fe4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="生成Podspec文件夹"></p>
<blockquote>
<p> <strong>Example:</strong> 放demo应用</p>
<p> <strong>LanguageSet:</strong> &#x2F;Classes主代码 &#x2F;Assets图片资源文件</p>
</blockquote>
<p><strong>将之前生成的XCFramework拖入新建Podspec文件夹中的LanguageSet中</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-60eec0705967d61c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="XCFramework拖入后"></p>
<h2 id="创建Git仓库"><a href="#创建Git仓库" class="headerlink" title="创建Git仓库"></a>创建Git仓库</h2><p><img src="https://upload-images.jianshu.io/upload_images/1976231-efca2c60c3794fd4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建Git仓库"></p>
<p><strong>修改LanguageSet.podspec配置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Pod::Spec.new do |s|</span><br><span class="line">  s.name             = &#x27;LanguageSet&#x27;</span><br><span class="line">  s.version          = &#x27;0.0.1&#x27;</span><br><span class="line">  s.summary          = &#x27;multilingual processing.&#x27;</span><br><span class="line"></span><br><span class="line">  s.description      = &lt;&lt;-DESC</span><br><span class="line">  A few simple lines of code can handle multiple languages</span><br><span class="line">  DESC</span><br><span class="line"></span><br><span class="line">  s.homepage         = &#x27;https://github.com/GavinCarter1991/LanguageSet&#x27;</span><br><span class="line">  s.license          = &#123; :type =&gt; &#x27;MIT&#x27;, :file =&gt; &#x27;LICENSE&#x27; &#125;</span><br><span class="line">  s.author           = &#123; &#x27;gavin&#x27; =&gt; &#x27;kindyourself@163.com&#x27; &#125;</span><br><span class="line">  s.source           = &#123; :git =&gt; &#x27;https://github.com/GavinCarter1991/LanguageSet.git&#x27;, :tag =&gt; s.version.to_s &#125;</span><br><span class="line"></span><br><span class="line">  s.ios.deployment_target = &#x27;12.0&#x27;</span><br><span class="line">  s.vendored_frameworks = &#x27;LanguageSet/Classes/LanguageSet.xcframework&#x27;</span><br><span class="line">  # 添加模块映射</span><br><span class="line">  s.preserve_paths = &#x27;LanguageSet/Classes/LanguageSet.xcframework&#x27;</span><br><span class="line">  </span><br><span class="line">  # 添加资源处理排除规则</span><br><span class="line">  s.pod_target_xcconfig = &#123;</span><br><span class="line">    &#x27;EXCLUDED_FILE_GROUP_PATTERNS&#x27; =&gt; [</span><br><span class="line">      &#x27;**/LanguageSet.xcframework/**/_CodeSignature/**&#x27;,</span><br><span class="line">      &#x27;**/LanguageSet.xcframework/**/Modules/**&#x27;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  # 禁用模块验证（针对 xcframework）</span><br><span class="line">  s.user_target_xcconfig = &#123; &#x27;VALIDATE_WORKSPACE&#x27; =&gt; &#x27;NO&#x27; &#125;</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p><strong>设置Git仓库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 创建本地仓库</span><br><span class="line">cd LanguageSet 进入文件夹</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line"></span><br><span class="line"># 创建远程仓库（在Gitee/GitHub上创建）</span><br><span class="line">git remote add origin https://github.com/GavinCarter1991/LanguageSet.git // 关联仓库</span><br><span class="line">git push -u origin main</span><br><span class="line"></span><br><span class="line"># 添加版本标签</span><br><span class="line">git tag 0.0.1</span><br><span class="line">git push --tags</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1976231-abf0ebb55afd72eb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="tags"></p>
<h2 id="发布到CocoaPods"><a href="#发布到CocoaPods" class="headerlink" title="发布到CocoaPods"></a>发布到CocoaPods</h2><p><strong>1. 首次发布</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 验证podspec</span><br><span class="line">pod lib lint --allow-warnings</span><br><span class="line"></span><br><span class="line"># 发布到CocoaPods</span><br><span class="line">pod trunk push CocoaPodsDemo.podspec --allow-warnings</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1976231-6524cd38c321ead0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="发布到CocoaPods"></p>
<p><strong>2. 更新版本</strong></p>
<blockquote>
<p>更新podspec中的版本号</p>
</blockquote>
<blockquote>
<p>推送新代码到你的库的 Git 仓库，创建新的Git标签(tag)</p>
</blockquote>
<blockquote>
<p>重复推送和发布的步骤</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/GavinCarter1991/LanguageSet">Demo</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Github/" rel="tag">Github</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9Ccocoapods%E2%80%9D/" rel="tag">“cocoapods”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CiOS%E2%80%9D/" rel="tag">“iOS”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%91%E5%B8%83/" rel="tag">发布</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-iOS即时通讯发送图片消息内存暴涨优化"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2025/06/16/iOS%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E5%8F%91%E9%80%81%E5%9B%BE%E7%89%87%E6%B6%88%E6%81%AF%E5%86%85%E5%AD%98%E6%9A%B4%E6%B6%A8%E4%BC%98%E5%8C%96/"
    >iOS即时通讯发送图片消息内存暴涨优化</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/06/16/iOS%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E5%8F%91%E9%80%81%E5%9B%BE%E7%89%87%E6%B6%88%E6%81%AF%E5%86%85%E5%AD%98%E6%9A%B4%E6%B6%A8%E4%BC%98%E5%8C%96/" class="article-date">
  <time datetime="2025-06-16T05:55:07.000Z" itemprop="datePublished">2025-06-16</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h3 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h3><blockquote>
<p>即时通讯App在发送图片消息时内存暴涨导致网络请求初始化失败（内存不足OOM），发送消息失败。</p>
</blockquote>
<h3 id="可能原因分析："><a href="#可能原因分析：" class="headerlink" title="可能原因分析："></a>可能原因分析：</h3><ol>
<li>有内存泄漏。</li>
<li>发送的图片消息，可能包含大图，没有进行压缩处理，导致内存占用过高。</li>
<li>在发送过程中，可能同时进行了图片的读取和处理，如果图片很大，处理过程中会产生很大的内存峰值。</li>
</ol>
<h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><ol>
<li><strong>对于发送消息时的内存暴涨：</strong></li>
</ol>
<ul>
<li>检查是否有内存泄漏，使用Instruments工具检测。</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-75e63fb317acf3a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Instruments工具检测结果"></p>
<p><strong>检测发现确实有内存泄漏，解决后发现问题还是存在。</strong></p>
<ul>
<li><p>在发送图片消息前，对图片进行压缩（包括压缩质量和尺寸），然后再发送压缩后的图片。</p>
</li>
<li><p>避免直接操作大图，可以使用后台线程进行处理，防止阻塞主线程。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">    // 1. 读取图片（避免使用imageNamed:）</span><br><span class="line">    UIImage *originalImage = [UIImage imageWithContentsOfFile:filePath];</span><br><span class="line">    </span><br><span class="line">    // 2. 尺寸压缩（限制最大边长为1024）</span><br><span class="line">    CGFloat maxSize = 1024.0;</span><br><span class="line">    CGSize scaledSize = [self scaledSizeForImage:originalImage maxLength:maxSize];</span><br><span class="line">    </span><br><span class="line">    // 3. 质量压缩（70%质量）</span><br><span class="line">    UIImage *compressedImage = [self resizeImage:originalImage toSize:scaledSize];</span><br><span class="line">    NSData *imageData = UIImageJPEGRepresentation(compressedImage, 0.7);</span><br><span class="line">    </span><br><span class="line">    // 4. 发送压缩后的数据（非原始图片）</span><br><span class="line">    [self sendImageData:imageData];</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 计算缩放尺寸</span><br><span class="line">- (CGSize)scaledSizeForImage:(UIImage *)image maxLength:(CGFloat)maxLength &#123;</span><br><span class="line">    CGFloat ratio = MIN(maxLength / image.size.width, maxLength / image.size.height);</span><br><span class="line">    return CGSizeMake(image.size.width * ratio, image.size.height * ratio);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 图片重绘</span><br><span class="line">- (UIImage *)resizeImage:(UIImage *)image toSize:(CGSize)targetSize &#123;</span><br><span class="line">    UIGraphicsBeginImageContextWithOptions(targetSize, NO, UIScreen.mainScreen.scale);</span><br><span class="line">    [image drawInRect:CGRectMake(0, 0, targetSize.width, targetSize.height)];</span><br><span class="line">    UIImage *resizedImage = UIGraphicsGetImageFromCurrentImageContext();</span><br><span class="line">    UIGraphicsEndImageContext();</span><br><span class="line">    return resizedImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>压缩后的图片数据要及时释放不必要的资源，避免在内存中同时存在多张图片，比如在图片展示后，如果原图不再需要，可以将其置为nil，帮助内存回收。（@autoreleasepool）。</li>
</ul>
<p><strong>处理到此内存暴涨解决了，但是随着发送图片内存还是在持续增加，现在每发送一张图片内存还是要涨10M。（message.compressRatio &#x3D; 1.0 &#x2F;&#x2F; 设置压缩率），message.compressRatio &#x3D; 0.2，每发送一张图片内存也要涨5M。</strong></p>
<h3 id="新问题："><a href="#新问题：" class="headerlink" title="新问题："></a>新问题：</h3><blockquote>
<p>即时通讯App在发送图片消息时每次展示一张图片内存涨10M多。</p>
</blockquote>
<h3 id="可能原因分析：-1"><a href="#可能原因分析：-1" class="headerlink" title="可能原因分析："></a>可能原因分析：</h3><p>1.<strong>图片加载方法不对</strong> </p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-6e9d4b44497cf943.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Cell图片展示"></p>
<p><strong>[UIImage imageNamed:]的内存缓存特性：</strong> </p>
<ul>
<li><p>系统级缓存无法自动释放</p>
</li>
<li><p>特别不适合大图和列表展示场景</p>
</li>
<li><p>会自动缓存图片到系统缓存</p>
</li>
<li><p>适合重复使用的小图标</p>
</li>
<li><p>不适合大图或单次使用的图片</p>
</li>
</ul>
<p>2.<strong>内存增长原因：</strong></p>
<p><code>为了支持 GIF/WebP 等动图格式，showImageView为SDAnimatedImageView，它解码后的帧缓存会增加内存占用。 </code></p>
<ul>
<li><p>大图被缓存且无法及时释放</p>
</li>
<li><p>图片解码后的位图数据占用内存</p>
</li>
</ul>
<p>3.<strong>Cell 复用机制</strong></p>
<p>快速滑动时可能同时加载多张大图，旧图片未及时释放</p>
<h3 id="优化方案："><a href="#优化方案：" class="headerlink" title="优化方案："></a>优化方案：</h3><blockquote>
<p>通过以下优化措施，图片展示内存问题应该能得到显著改善。核心要点是：</p>
</blockquote>
<ul>
<li><p>避免使用 imageNamed: 加载大图</p>
</li>
<li><p>合理配置 SDAnimatedImageView</p>
</li>
<li><p>完善 cell 复用机制</p>
</li>
<li><p>使用图片下采样技术</p>
</li>
<li><p>滑动时优化资源使用</p>
</li>
</ul>
<p><strong>1.使用正确的图片加载方式，用  [UIImage imageWithContentsOfFile:filePath]替代[UIImage imageNamed:filePath]</strong></p>
<p><strong>优点：</strong></p>
<ul>
<li><p>不会缓存图片</p>
</li>
<li><p>适合大图和单次使用的图片</p>
</li>
</ul>
<p><strong>后台线程解码 + 尺寸适配</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 后台线程处理图片</span><br><span class="line">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        // 1. 从文件加载</span><br><span class="line">        UIImage *originalImage = [UIImage imageWithContentsOfFile:filePath];</span><br><span class="line">        </span><br><span class="line">        // 2. 压缩图片尺寸 (按需)</span><br><span class="line">        CGSize targetSize = CGSizeMake(800, 800); // 根据需求调整</span><br><span class="line">        UIGraphicsBeginImageContextWithOptions(targetSize, NO, [UIScreen mainScreen].scale);</span><br><span class="line">        [originalImage drawInRect:CGRectMake(0, 0, targetSize.width, targetSize.height)];</span><br><span class="line">        UIImage *scaledImage = UIGraphicsGetImageFromCurrentImageContext();</span><br><span class="line">        UIGraphicsEndImageContext();</span><br><span class="line">        </span><br><span class="line">        // 3. 主线程更新UI</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            self.showImageView.image = scaledImage;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>2.使用 ImageIO 框架高效加载</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;ImageIO/ImageIO.h&gt;</span><br><span class="line"></span><br><span class="line">NSURL *imageURL = [NSURL fileURLWithPath:filePath];</span><br><span class="line">NSDictionary *options = @&#123;(id)kCGImageSourceShouldCache: @NO&#125;; // 禁用解码缓存</span><br><span class="line">CGImageSourceRef source = CGImageSourceCreateWithURL((CFURLRef)imageURL, NULL);</span><br><span class="line">CGImageRef imageRef = CGImageSourceCreateImageAtIndex(source, 0, (CFDictionaryRef)options);</span><br><span class="line">UIImage *image = [UIImage imageWithCGImage:imageRef];</span><br><span class="line">CGImageRelease(imageRef);</span><br><span class="line">CFRelease(source);</span><br><span class="line"></span><br><span class="line">self.showImageView.image = image;</span><br></pre></td></tr></table></figure>

<p><strong>3.使用第三方图片加载库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 使用SDWebImage示例</span><br><span class="line">#import &lt;SDWebImage/SDWebImage.h&gt;</span><br><span class="line"></span><br><span class="line">[self.showImageView sd_setImageWithURL:[NSURL fileURLWithPath:filePath]placeholderImage:nil</span><br><span class="line">                           completed:^(UIImage *image, NSError *error,</span><br><span class="line">                           SDImageCacheType cacheType, </span><br><span class="line">                           NSURL *imageURL) &#123;</span><br><span class="line">                               // 加载完成回调</span><br><span class="line"> &#125;];</span><br></pre></td></tr></table></figure>

<p><strong>4.优化 SDAnimatedImageView 配置</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (SDAnimatedImageView *)showImageView &#123;</span><br><span class="line">    if (!_showImageView) &#123;</span><br><span class="line">        _showImageView = [[SDAnimatedImageView alloc] init];</span><br><span class="line">        _showImageView.contentMode = UIViewContentModeScaleAspectFill;</span><br><span class="line">        _showImageView.userInteractionEnabled = YES;</span><br><span class="line">        </span><br><span class="line">        // 添加以下优化配置</span><br><span class="line">        _showImageView.shouldIncrementalLoad = YES; // 渐进式加载</span><br><span class="line">        _showImageView.maxBufferSize = 1024 * 1024; // 设置合理的缓冲区大小</span><br><span class="line">        _showImageView.runLoopMode = NSDefaultRunLoopMode; // 滑动时暂停动画</span><br><span class="line">    &#125;</span><br><span class="line">    return _showImageView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.Cell 复用时的内存管理</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 在 cell 的 prepareForReuse 中清理</span><br><span class="line">- (void)prepareForReuse &#123;</span><br><span class="line">    [super prepareForReuse];</span><br><span class="line">    </span><br><span class="line">    // 停止动画并释放资源</span><br><span class="line">    [self.showImageView stopAnimating];</span><br><span class="line">    self.showImageView.currentFrame = nil;</span><br><span class="line">    self.showImageView.animationImages = nil;</span><br><span class="line">    </span><br><span class="line">    // 取消未完成的图片加载</span><br><span class="line">    [self.showImageView sd_cancelCurrentImageLoad];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6.图片尺寸优化（针对大图）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 使用 ImageIO 进行下采样</span><br><span class="line">- (UIImage *)downsampleImageAtPath:(NSString *)path toSize:(CGSize)size &#123;</span><br><span class="line">    NSURL *url = [NSURL fileURLWithPath:path];</span><br><span class="line">    NSDictionary *options = @&#123;</span><br><span class="line">        (id)kCGImageSourceShouldCache: @NO,</span><br><span class="line">        (id)kCGImageSourceShouldAllowFloat: @YES</span><br><span class="line">    &#125;;</span><br><span class="line">    CGImageSourceRef source = CGImageSourceCreateWithURL((CFURLRef)url, NULL);</span><br><span class="line">    </span><br><span class="line">    CGFloat maxDimension = MAX(size.width, size.height) * [UIScreen mainScreen].scale;</span><br><span class="line">    NSDictionary *downsampleOptions = @&#123;</span><br><span class="line">        (id)kCGImageSourceCreateThumbnailFromImageAlways: @YES,</span><br><span class="line">        (id)kCGImageSourceShouldCacheImmediately: @YES,</span><br><span class="line">        (id)kCGImageSourceThumbnailMaxPixelSize: @(maxDimension)</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    CGImageRef imageRef = CGImageSourceCreateThumbnailAtIndex(source, 0, (CFDictionaryRef)downsampleOptions);</span><br><span class="line">    UIImage *image = [UIImage imageWithCGImage:imageRef];</span><br><span class="line">    </span><br><span class="line">    if (imageRef) CFRelease(imageRef);</span><br><span class="line">    if (source) CFRelease(source);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    return image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>7.滑动性能优化</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 在 scrollView 代理中实现以下方法</span><br><span class="line">- (void)scrollViewDidScroll:(UIScrollView *)scrollView &#123;</span><br><span class="line">    // 暂停屏幕外 cell 的动画</span><br><span class="line">    for (UITableViewCell *cell in self.tableView.visibleCells) &#123;</span><br><span class="line">        if ([cell isKindOfClass:[YourCellClass class]]) &#123;</span><br><span class="line">            YourCellClass *yourCell = (YourCellClass *)cell;</span><br><span class="line">            [yourCell.showImageView startAnimating];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 暂停非可见 cell 的动画</span><br><span class="line">    NSArray *visiblePaths = [self.tableView indexPathsForVisibleRows];</span><br><span class="line">    for (NSIndexPath *indexPath in self.loadedIndexPaths) &#123;</span><br><span class="line">        if (![visiblePaths containsObject:indexPath]) &#123;</span><br><span class="line">            YourCellClass *cell = (YourCellClass *)[self.tableView cellForRowAtIndexPath:indexPath];</span><br><span class="line">            [cell.showImageView stopAnimating];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="其他优化建议："><a href="#其他优化建议：" class="headerlink" title="其他优化建议："></a>其他优化建议：</h3><p><strong>1.内存警告处理</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (void)didReceiveMemoryWarning &#123;</span><br><span class="line">    [super didReceiveMemoryWarning];</span><br><span class="line">    // 清除所有图片缓存</span><br><span class="line">    [[SDImageCache sharedImageCache] clearMemory];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.使用合适的 SDWebImage 选项：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[self.showImageView sd_setImageWithURL:imageURL</span><br><span class="line">                    placeholderImage:nil</span><br><span class="line">                           options:SDWebImageAvoidDecodeImage | </span><br><span class="line">                                   SDWebImageScaleDownLargeImages |</span><br><span class="line">                                   SDWebImageProgressiveLoad</span><br><span class="line">                          completed:nil];</span><br></pre></td></tr></table></figure>

<p><strong>3.监控内存使用：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (void)monitorMemoryUsage &#123;</span><br><span class="line">    struct task_basic_info info;</span><br><span class="line">    mach_msg_type_number_t size = sizeof(info);</span><br><span class="line">    kern_return_t kerr = task_info(mach_task_self(),</span><br><span class="line">                                 TASK_BASIC_INFO,</span><br><span class="line">                                 (task_info_t)&amp;info,</span><br><span class="line">                                 &amp;size);</span><br><span class="line">    if (kerr == KERN_SUCCESS) &#123;</span><br><span class="line">        NSLog(@&quot;Memory in use (in MB): %f&quot;, info.resident_size / 1024.0 / 1024.0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4.配置 SDWebImage 全局参数（AppDelegate 中）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 设置全局缓存策略</span><br><span class="line">SDImageCacheConfig *cacheConfig = [SDImageCacheConfig defaultCacheConfig];</span><br><span class="line">cacheConfig.maxMemoryCost = 100 * 1024 * 1024; // 100MB 内存缓存</span><br><span class="line">cacheConfig.maxMemoryCount = 50; // 最大缓存图片数量</span><br><span class="line">cacheConfig.shouldDecompressImages = NO; // 禁止自动解压</span><br><span class="line">[SDImageCache sharedImageCache].config = cacheConfig;</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1976231-aabb2e60704bb072.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="性能对比"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UIImage/" rel="tag">UIImage</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CIMSDK%E2%80%9D/" rel="tag">“IMSDK”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CiOS%E2%80%9D/" rel="tag">“iOS”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BC%98%E5%8C%96%E5%86%85%E5%AD%98/" rel="tag">优化内存</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-iOS-SM3加密算法N种集成"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2025/06/13/iOS-SM3%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95N%E7%A7%8D%E9%9B%86%E6%88%90/"
    >iOS-SM3加密算法N种集成</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/06/13/iOS-SM3%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95N%E7%A7%8D%E9%9B%86%E6%88%90/" class="article-date">
  <time datetime="2025-06-13T10:55:07.000Z" itemprop="datePublished">2025-06-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>近期的一个项目需要用到SM3加密算法，需要在iOS中使用Objective-C实现SM3国密加密算法。</p>
<blockquote>
<p>SM3：是中国国家密码管理局发布的密码杂凑算法标准，适用于商用密码应用中的数字签名和验证、消息认证码的生成与验证以及随机数的生成等</p>
<p>由于iOS系统并未内置SM3算法，我们需要使用第三方开源库或自己实现</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/muzipiao/GMObjC">GMObjC</a>库：</strong> 是一个基于 OpenSSL 的国密（SM2、SM3、SM4）算法的 Objective-C 开源库，适用于 iOS 和 macOS 开发。它封装了中国国家密码管理局发布的多种加密算法，包括：</p>
</blockquote>
<blockquote>
<p><strong>1. SM2：</strong> 支持基于椭圆曲线（ECC）的加解密，密钥协商（ECDH）和签名算法</p>
<p><strong>2. SM3：</strong> 类似 SHA 系列的国密哈希算法，包含 SM3 和 HMAC 等</p>
<p><strong>3. SM4：</strong> 实现对称分组加密算法</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/guanzhi/GmSSL#">GmSSL</a>库：</strong>GmSSL是由北京大学自主开发的国产商用密码开源库，实现了对国密算法、标准和安全通信协议的全面功能覆盖，支持包括移动端在内的主流操作系统和处理器，支持密码钥匙、密码卡等典型国产密码硬件，提供功能丰富的命令行工具及多种编译语言编程接口</p>
</blockquote>
<h2 id="方案一：使用第三方库（GMObjC）"><a href="#方案一：使用第三方库（GMObjC）" class="headerlink" title="方案一：使用第三方库（GMObjC）"></a>方案一：使用第三方库（GMObjC）</h2><p>集成GMObjC：<a target="_blank" rel="noopener" href="https://muzipiao.github.io/gmdocs/zh/guide/getting-started">集成GMObjC方法</a></p>
<p>因为我们的项目是SDK不便用CocoaPods方法，因此我只能选择直接集成和手动编译为 Framework。</p>
<h3 id="1-直接集成-demo"><a href="#1-直接集成-demo" class="headerlink" title="1.直接集成 (demo)"></a>1.直接集成 (<a target="_blank" rel="noopener" href="https://github.com/GavinCarter1991/sm3-demo/tree/GMObjC%EF%BC%88%E7%9B%B4%E6%8E%A5%E9%9B%86%E6%88%90%EF%BC%89">demo</a>)</h3><blockquote>
<p>1.从 Git 下载最新代码，找到和 README 同级的 GMObjC 文件夹，将 GMObjC 文件夹拖入项目</p>
<p>2.找到和 README 同级的 Frameworks 文件夹，将项目 Frameworks&#x2F;OpenSSL.xcframework 拖入项目</p>
<p>3.在需要使用的地方导入头文件 GMObjC.h 即可使用 SM2、SM4 加解密，签名验签，计算 SM3 摘要等</p>
</blockquote>
<p><strong>注意事项</strong></p>
<p><code> GMObjC 依赖 OpenSSL，可直接拖入 Frameworks/OpenSSL.xcframework 或通过pod GMOpenSSL安装 OpenSSL。</code></p>
<p><code> 如果项目中已集成 OpenSSL 1.1.1l 以上版本，可共用同一个 OpenSSL；否则需要使用 Carthage 将 GMObjC 编译为动态库。</code></p>
<p><strong>我按照以上步骤将文件导入后报错：</strong><br>OpenSSL.xcframework 签名验证失败</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-53feb7bc56f237bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="OpenSSL.xcframework报错"></p>
<p><strong>终端执行强制重签名命令</strong></p>
<p>codesign –force –deep –sign - 你的路径&#x2F;OpenSSL.xcframework</p>
<p>返回：你的路径&#x2F;OpenSSL.xcframework: replacing existing signature</p>
<p>现在就可以运行测试了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;GMObjC.h&quot;</span><br><span class="line"></span><br><span class="line">NSString *str = @&quot;123@1234&quot;;</span><br><span class="line">NSString *digest = [GMSm3Utils hashWithText:str];</span><br><span class="line">NSLog(@&quot;%@&quot;, digest);</span><br></pre></td></tr></table></figure>

<h3 id="2-手动编译为-Framework-demo"><a href="#2-手动编译为-Framework-demo" class="headerlink" title="2.手动编译为 Framework (demo)"></a>2.手动编译为 Framework (<a target="_blank" rel="noopener" href="https://github.com/GavinCarter1991/sm3-demo/tree/GMObjC-Framework%EF%BC%88%E6%89%8B%E5%8A%A8%E7%BC%96%E8%AF%91%EF%BC%89">demo</a>)</h3><p>1.<strong>动态库‌：</strong></p>
<blockquote>
<p>从 GitHub 下载源码，打开项目GMObjC-master&#x2F;Frameworks&#x2F;GMObjC.xcframework把这个拖入项目</p>
<p>在 Xcode 的 General → Frameworks, Libraries, and Embedded Content 中需标记为 Embed &amp; Sign</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-30c18fc5528e087b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Embed &amp; Sign"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;GMObjC/GMObjC.h&quot;</span><br><span class="line"></span><br><span class="line">NSString *digest1 = [GMSm3Utils hashWithText:str];</span><br><span class="line">NSLog(@&quot;%@&quot;, digest1);</span><br></pre></td></tr></table></figure>

<p>2.<strong>静态库：</strong></p>
<blockquote>
<p>从 GitHub 下载源码，打开项目 GMObjC.xcodeproj，设置 Build Settings - Linking-General - Mach-O Type 为 Static Library</p>
<p>手动编译为静态库 GMObjC.framework</p>
<p><strong>合并为 XCFramework：</strong>通过xcodebuild -create-xcframework命令来合并为 XCFramework，通过合并 GMObjC 库的模拟器和真机版本来演示</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建合并包 GMObjC.xcframework</span><br><span class="line"></span><br><span class="line">xcodebuild -create-xcframework \</span><br><span class="line">           -framework Release-iphoneos/GMObjC.framework \</span><br><span class="line">           -framework Release-iphonesimulator/GMObjC.framework \</span><br><span class="line">           -output GMObjC.xcframework</span><br></pre></td></tr></table></figure>
<p><strong>把生成的GMObjC.xcframework拖入项目即可</strong></p>
<h3 id="3-CocoaPods安装GMObjC-GMObjC-demo-GMDynamic-demo"><a href="#3-CocoaPods安装GMObjC-GMObjC-demo-GMDynamic-demo" class="headerlink" title="3.CocoaPods安装GMObjC  (GMObjC-demo) (GMDynamic-demo)"></a>3.CocoaPods安装GMObjC  (<a target="_blank" rel="noopener" href="https://github.com/GavinCarter1991/sm3-demo/tree/GMObjC-CocoaPods">GMObjC-demo</a>) (<a target="_blank" rel="noopener" href="https://github.com/GavinCarter1991/sm3-demo/tree/GMDynamic-CocoaPods">GMDynamic-demo</a>)</h3><blockquote>
<p>GMObjC 和 GMDynamic 只能安装其中一个，二者不能同时安装。</p>
<p>GMObjC 为静态库，GMDynamic 为编译好的 GMObjC 动态库版本。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 安装 GMObjC 的源码和 GMOpenSSL.xcframework (静态库)</span><br><span class="line">pod &#x27;GMObjC&#x27;, &#x27;~&gt; 4.0.3&#x27;</span><br><span class="line"></span><br><span class="line"># 当 Podfile 中使用 use_frameworks! 时，安装 GMObjC.xcframework (动态库)</span><br><span class="line">pod &#x27;GMDynamic&#x27;, &#x27;~&gt; 4.0.3&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="方案二：使用第三方库（GmSSL）-demo"><a href="#方案二：使用第三方库（GmSSL）-demo" class="headerlink" title="方案二：使用第三方库（GmSSL）(demo)"></a>方案二：使用第三方库（GmSSL）(<a target="_blank" rel="noopener" href="https://github.com/GavinCarter1991/sm3-demo/tree/GmSSL%EF%BC%88libgmssl.a%EF%BC%89">demo</a>)</h2><p><strong>集成GmSSL：</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-4e921d7eba588139.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="集成GmSSL方法"></p>
<p>但是我用这种方法不行，我用了其他的方法。</p>
<blockquote>
<p>我们使用GmSSL 3.x（master分支）来编译iOS的静态库（libcrypto.a和libssl.a）。由于3.x版本采用了CMake构建系统，因此流程与2.x不同。</p>
<p>GmSSL 3.x 的构建系统已经发生了变化，生成的库文件名为 libgmssl.a 而不是传统的 libcrypto.a 和 libssl.a。</p>
<p> 如果项目必须使用 <code>libcrypto.a</code> 和 <code>libssl.a</code>，请回退到 GmSSL 2.x</p>
</blockquote>
<ol>
<li><p>克隆代码并切换到master分支（或最新的稳定标签）</p>
</li>
<li><p>配置CMake工具链文件（为iOS交叉编译）</p>
</li>
<li><p>分别编译arm64（真机）和x86_64（模拟器）架构</p>
</li>
<li><p>使用lipo合并成通用静态库</p>
</li>
<li><p>将生成的静态库和头文件集成到iOS项目中。</p>
</li>
</ol>
<p><strong>创建编译脚本：</strong> build_ios.sh（放在GmSSL根目录）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"># 确保使用正确的路径</span><br><span class="line">export PATH=&quot;/usr/local/bin:$PATH&quot;</span><br><span class="line"></span><br><span class="line"># 设置环境变量</span><br><span class="line">export XCODE_PATH=$(xcode-select -p)</span><br><span class="line">export IOS_SDK=$XCODE_PATH/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk</span><br><span class="line">export SIM_SDK=$XCODE_PATH/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk</span><br><span class="line"></span><br><span class="line"># 创建输出目录</span><br><span class="line">OUTPUT_DIR=&quot;build-ios&quot;</span><br><span class="line">rm -rf $OUTPUT_DIR</span><br><span class="line">mkdir -p $OUTPUT_DIR</span><br><span class="line"></span><br><span class="line"># 编译函数</span><br><span class="line">compile_arch() &#123;</span><br><span class="line">    ARCH=$1</span><br><span class="line">    SDK=$2</span><br><span class="line">    </span><br><span class="line">    BUILD_DIR=&quot;$&#123;OUTPUT_DIR&#125;/$&#123;ARCH&#125;&quot;</span><br><span class="line">    mkdir -p $BUILD_DIR</span><br><span class="line">    pushd $BUILD_DIR &gt; /dev/null</span><br><span class="line">    </span><br><span class="line">    echo &quot;▸ 配置 $ARCH...&quot;</span><br><span class="line">    cmake ../.. \</span><br><span class="line">        -DCMAKE_SYSTEM_NAME=iOS \</span><br><span class="line">        -DCMAKE_OSX_ARCHITECTURES=$ARCH \</span><br><span class="line">        -DCMAKE_OSX_SYSROOT=$SDK \</span><br><span class="line">        -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \</span><br><span class="line">        -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">        -DBUILD_SHARED_LIBS=OFF \</span><br><span class="line">        -DENABLE_SM2=ON \</span><br><span class="line">        -DENABLE_SM3=ON \</span><br><span class="line">        -DENABLE_SM4=ON \</span><br><span class="line">        -DENABLE_SM9=ON \</span><br><span class="line">        -G Ninja</span><br><span class="line">        </span><br><span class="line">    echo &quot;▸ 编译 $ARCH...&quot;</span><br><span class="line">    ninja</span><br><span class="line">    </span><br><span class="line">    # 关键修改：GmSSL 3.x 生成的库是 libgmssl.a</span><br><span class="line">    mkdir -p lib</span><br><span class="line">    cp bin/libgmssl.a lib/</span><br><span class="line">    </span><br><span class="line">    popd &gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 编译各架构</span><br><span class="line">compile_arch &quot;arm64&quot; &quot;$IOS_SDK&quot;</span><br><span class="line">compile_arch &quot;x86_64&quot; &quot;$SIM_SDK&quot;</span><br><span class="line"></span><br><span class="line"># 合并通用库</span><br><span class="line">UNIVERSAL_DIR=&quot;$&#123;OUTPUT_DIR&#125;/universal&quot;</span><br><span class="line">mkdir -p $UNIVERSAL_DIR/lib</span><br><span class="line"></span><br><span class="line"># 合并为单个库 (GmSSL 3.x 只生成一个库)</span><br><span class="line">lipo -create \</span><br><span class="line">    &quot;$&#123;OUTPUT_DIR&#125;/arm64/lib/libgmssl.a&quot; \</span><br><span class="line">    &quot;$&#123;OUTPUT_DIR&#125;/x86_64/lib/libgmssl.a&quot; \</span><br><span class="line">    -output &quot;$UNIVERSAL_DIR/lib/libgmssl.a&quot;</span><br><span class="line"></span><br><span class="line"># 复制头文件</span><br><span class="line">if [ -d &quot;$&#123;OUTPUT_DIR&#125;/arm64/include&quot; ]; then</span><br><span class="line">    cp -R &quot;$&#123;OUTPUT_DIR&#125;/arm64/include&quot; &quot;$UNIVERSAL_DIR/&quot;</span><br><span class="line">elif [ -d &quot;../../include&quot; ]; then</span><br><span class="line">    cp -R &quot;../../include&quot; &quot;$UNIVERSAL_DIR/&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;⚠️ 警告: 找不到头文件目录&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;✅ 编译成功！&quot;</span><br><span class="line">echo &quot;库文件位置: $UNIVERSAL_DIR/lib/libgmssl.a&quot;</span><br><span class="line">echo &quot;头文件位置: $UNIVERSAL_DIR/include&quot;</span><br><span class="line"></span><br><span class="line"># 验证文件</span><br><span class="line">file &quot;$UNIVERSAL_DIR/lib&quot;/*.a</span><br><span class="line">lipo -info &quot;$UNIVERSAL_DIR/lib/libgmssl.a&quot;</span><br></pre></td></tr></table></figure>

<p><strong>然后按照以下步骤进行执行：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 安装构建工具</span><br><span class="line">brew install cmake ninja pkg-config</span><br><span class="line"></span><br><span class="line"># 获取最新代码</span><br><span class="line">git clone https://github.com/guanzhi/GmSSL.git</span><br><span class="line">cd GmSSL</span><br><span class="line">git checkout master  # 确保使用最新版本</span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"># 2. 执行编译</span><br><span class="line">chmod +x build_ios.sh</span><br><span class="line">./build_ios.sh</span><br></pre></td></tr></table></figure>

<ol>
<li><p>将GmSSL&#x2F;build-ios&#x2F;universal&#x2F;lib&#x2F;libgmssl.a 拖入项目</p>
</li>
<li><p>将GmSSL&#x2F;include&#x2F;gmssl 拖入项目</p>
</li>
<li><p>import “sm3.h”</p>
</li>
</ol>
<p><strong>封装方法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@interface GmSSLEncryptorSM3 : NSObject</span><br><span class="line"></span><br><span class="line">+ (NSString *)sm3HashWithString:(NSString *)input;</span><br><span class="line">+ (NSData *)sm3HashWithData:(NSData *)data;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation GmSSLEncryptorSM3</span><br><span class="line"></span><br><span class="line">+ (instancetype)encryptor &#123;</span><br><span class="line">    return [[GmSSLEncryptorSM3 alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (NSData *)sm3HashWithData:(NSData *)data &#123;</span><br><span class="line">    // 初始化 SM3 上下文</span><br><span class="line">    SM3_CTX ctx;</span><br><span class="line">    sm3_init(&amp;ctx);</span><br><span class="line">    // 添加数据到哈希计算</span><br><span class="line">    sm3_update(&amp;ctx, data.bytes, data.length);</span><br><span class="line">    // 准备存储结果的缓冲区 (SM3 输出为 32 字节)</span><br><span class="line">    uint8_t dgst[SM3_DIGEST_SIZE];</span><br><span class="line">    // 完成哈希计算</span><br><span class="line">    sm3_finish(&amp;ctx, dgst);</span><br><span class="line">    // 转换为 NSData</span><br><span class="line">    return [NSData dataWithBytes:dgst length:SM3_DIGEST_SIZE];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (NSString *)sm3HashWithString:(NSString *)input &#123;</span><br><span class="line">    NSData *inputData = [input dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    // 计算 SM3 哈希</span><br><span class="line">    NSData *hashData = [GmSSLEncryptorSM3 sm3HashWithData:inputData];</span><br><span class="line">    // 转换为十六进制字符串显示</span><br><span class="line">    NSMutableString *hexString = [NSMutableString string];</span><br><span class="line">    const uint8_t *bytes = (const uint8_t *)hashData.bytes;</span><br><span class="line">    for (NSUInteger i = 0; i &lt; hashData.length; i++) &#123;</span><br><span class="line">        [hexString appendFormat:@&quot;%02x&quot;, bytes[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    return hexString;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><strong>就可以在项目中使用了：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NSString *encryptor = [GmSSLEncryptorSM3 sm3HashWithString:str];</span><br><span class="line">NSLog(@&quot;%@&quot;, encryptor);</span><br></pre></td></tr></table></figure>

<h2 id="方案三：纯-Objective-C-实现（无依赖）-demo"><a href="#方案三：纯-Objective-C-实现（无依赖）-demo" class="headerlink" title="方案三：纯 Objective-C 实现（无依赖）(demo)"></a>方案三：纯 Objective-C 实现（无依赖）(<a target="_blank" rel="noopener" href="https://github.com/GavinCarter1991/sm3-demo/tree/SM3-%E7%BA%AFOC%E4%BB%A3%E7%A0%81">demo</a>)</h2><blockquote>
<p>SM3本质上不是加密算法，它是是一种杂凑函数，是在[SHA-256]基础上改进实现的一种算法，它不是对数据进行加密然后再解密，而是生成一个256位的散列值，因此SM3适用于内容摘要，数字签名验证或密码验证等。</p>
</blockquote>
<p><strong>SM3算法的执行过程：</strong></p>
<p>根据SM3标准文档（GM&#x2F;T 0004-2012）</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-b73f718c48617fcb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="sm3流程.png"></p>
<p><strong>消息扩展：</strong>将16个32位字扩展为68个字（W）和64个字（W1），使用P1宏。<br><strong>压缩函数：</strong>64轮迭代更新寄存器（A-H），每轮使用FF1&#x2F;GG1等宏。<br><strong>常量：</strong>压缩函数中的常量0x7A879D8A（TJ的固定值）。<br><strong>结果输出：</strong>将最终状态寄存器转换为大端序字节流（256位）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">//  SM3Encryptor.m</span><br><span class="line">//  testDemo</span><br><span class="line">//</span><br><span class="line">//  Created by wt on 2025/6/12.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">#import &quot;SM3Encryptor.h&quot;</span><br><span class="line">#include &lt;stdint.h&gt;</span><br><span class="line"></span><br><span class="line">// SM3 上下文结构</span><br><span class="line">typedef struct &#123;</span><br><span class="line">    uint32_t state[8];   // 8个32位寄存器（A-H）</span><br><span class="line">    uint64_t totalLength; // 总消息长度（位）</span><br><span class="line">    uint8_t buffer[64];  // 当前数据块缓存</span><br><span class="line">    uint32_t bufferLength; // 当前缓冲区长度</span><br><span class="line">&#125; SM3Context;</span><br><span class="line"></span><br><span class="line">// 循环左移</span><br><span class="line">static inline uint32_t ROTL(uint32_t x, uint8_t n) &#123;</span><br><span class="line">    return (x &lt;&lt; n) | (x &gt;&gt; (32 - n));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 布尔函数 FF0（0≤j≤15）</span><br><span class="line">static inline uint32_t FF0(uint32_t x, uint32_t y, uint32_t z) &#123;</span><br><span class="line">    return x ^ y ^ z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 布尔函数 FF1（16≤j≤63）</span><br><span class="line">static inline uint32_t FF1(uint32_t x, uint32_t y, uint32_t z) &#123;</span><br><span class="line">    return (x &amp; y) | (x &amp; z) | (y &amp; z);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 布尔函数 GG0（0≤j≤15）</span><br><span class="line">static inline uint32_t GG0(uint32_t x, uint32_t y, uint32_t z) &#123;</span><br><span class="line">    return x ^ y ^ z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 布尔函数 GG1（16≤j≤63）</span><br><span class="line">static inline uint32_t GG1(uint32_t x, uint32_t y, uint32_t z) &#123;</span><br><span class="line">    return (x &amp; y) | ((~x) &amp; z);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 置换函数 P0</span><br><span class="line">static inline uint32_t P0(uint32_t x) &#123;</span><br><span class="line">    return x ^ ROTL(x, 9) ^ ROTL(x, 17);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 置换函数 P1</span><br><span class="line">static inline uint32_t P1(uint32_t x) &#123;</span><br><span class="line">    return x ^ ROTL(x, 15) ^ ROTL(x, 23);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化SM3上下文</span><br><span class="line">void SM3Init(SM3Context *context) &#123;</span><br><span class="line">    // SM3标准初始值</span><br><span class="line">    context-&gt;state[0] = 0x7380166F;</span><br><span class="line">    context-&gt;state[1] = 0x4914B2B9;</span><br><span class="line">    context-&gt;state[2] = 0x172442D7;</span><br><span class="line">    context-&gt;state[3] = 0xDA8A0600;</span><br><span class="line">    context-&gt;state[4] = 0xA96F30BC;</span><br><span class="line">    context-&gt;state[5] = 0x163138AA;</span><br><span class="line">    context-&gt;state[6] = 0xE38DEE4D;</span><br><span class="line">    context-&gt;state[7] = 0xB0FB0E4E;</span><br><span class="line">    context-&gt;totalLength = 0;</span><br><span class="line">    context-&gt;bufferLength = 0;</span><br><span class="line">    memset(context-&gt;buffer, 0, 64);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 处理单个64字节块（压缩函数核心）</span><br><span class="line">void SM3Compress(SM3Context *context, const uint8_t block[64]) &#123;</span><br><span class="line">    // 1. 消息扩展：16字 → 68字（W） + 64字（W1）</span><br><span class="line">    uint32_t W[68], W1[64];</span><br><span class="line">    </span><br><span class="line">    // 初始化前16字（大端序转换）</span><br><span class="line">    for (int i = 0; i &lt; 16; i++) &#123;</span><br><span class="line">        W[i] = (uint32_t)block[i*4] &lt;&lt; 24 |</span><br><span class="line">               (uint32_t)block[i*4+1] &lt;&lt; 16 |</span><br><span class="line">               (uint32_t)block[i*4+2] &lt;&lt; 8 |</span><br><span class="line">               (uint32_t)block[i*4+3];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 计算W[16]-W[67]</span><br><span class="line">    for (int j = 16; j &lt; 68; j++) &#123;</span><br><span class="line">        uint32_t temp = W[j-16] ^ W[j-9] ^ ROTL(W[j-3], 15);</span><br><span class="line">        W[j] = P1(temp) ^ ROTL(W[j-13], 7) ^ W[j-6];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 计算W1[0]-W1[63]</span><br><span class="line">    for (int j = 0; j &lt; 64; j++) &#123;</span><br><span class="line">        W1[j] = W[j] ^ W[j+4];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 2. 寄存器初始化（A-H）</span><br><span class="line">    uint32_t A = context-&gt;state[0];</span><br><span class="line">    uint32_t B = context-&gt;state[1];</span><br><span class="line">    uint32_t C = context-&gt;state[2];</span><br><span class="line">    uint32_t D = context-&gt;state[3];</span><br><span class="line">    uint32_t E = context-&gt;state[4];</span><br><span class="line">    uint32_t F = context-&gt;state[5];</span><br><span class="line">    uint32_t G = context-&gt;state[6];</span><br><span class="line">    uint32_t H = context-&gt;state[7];</span><br><span class="line">    </span><br><span class="line">    // 3. 64轮迭代（严格遵循标准）</span><br><span class="line">    for (int j = 0; j &lt; 64; j++) &#123;</span><br><span class="line">        uint32_t SS1, SS2, TT1, TT2;</span><br><span class="line">        </span><br><span class="line">        // 常量选择（关键修正）</span><br><span class="line">        uint32_t TJ = (j &lt; 16) ? 0x79CC4519 : 0x7A879D8A;</span><br><span class="line">        </span><br><span class="line">        // 计算SS1/SS2（修正了TJ参数）</span><br><span class="line">        SS1 = ROTL(ROTL(A, 12) + E + ROTL(TJ, j % 32), 7);</span><br><span class="line">        SS2 = SS1 ^ ROTL(A, 12);</span><br><span class="line">        </span><br><span class="line">        // 计算TT1/TT2（使用内联函数）</span><br><span class="line">        if (j &lt; 16) &#123;</span><br><span class="line">            TT1 = FF0(A, B, C) + D + SS2 + W1[j];</span><br><span class="line">            TT2 = GG0(E, F, G) + H + SS1 + W[j];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            TT1 = FF1(A, B, C) + D + SS2 + W1[j];</span><br><span class="line">            TT2 = GG1(E, F, G) + H + SS1 + W[j];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 更新寄存器（严格顺序）</span><br><span class="line">        D = C;</span><br><span class="line">        C = ROTL(B, 9);</span><br><span class="line">        B = A;</span><br><span class="line">        A = TT1;</span><br><span class="line">        H = G;</span><br><span class="line">        G = ROTL(F, 19);</span><br><span class="line">        F = E;</span><br><span class="line">        E = P0(TT2);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 4. 更新最终状态（与初始IV异或）</span><br><span class="line">    context-&gt;state[0] ^= A;</span><br><span class="line">    context-&gt;state[1] ^= B;</span><br><span class="line">    context-&gt;state[2] ^= C;</span><br><span class="line">    context-&gt;state[3] ^= D;</span><br><span class="line">    context-&gt;state[4] ^= E;</span><br><span class="line">    context-&gt;state[5] ^= F;</span><br><span class="line">    context-&gt;state[6] ^= G;</span><br><span class="line">    context-&gt;state[7] ^= H;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 更新数据（可分多次调用）</span><br><span class="line">void SM3Update(SM3Context *context, const uint8_t *data, size_t length) &#123;</span><br><span class="line">    context-&gt;totalLength += length * 8; // 更新总位数（字节转位）</span><br><span class="line">    </span><br><span class="line">    // 处理缓冲区中的剩余空间</span><br><span class="line">    if (context-&gt;bufferLength &gt; 0) &#123;</span><br><span class="line">        size_t copySize = MIN(64 - context-&gt;bufferLength, length);</span><br><span class="line">        memcpy(context-&gt;buffer + context-&gt;bufferLength, data, copySize);</span><br><span class="line">        context-&gt;bufferLength += copySize;</span><br><span class="line">        data += copySize;</span><br><span class="line">        length -= copySize;</span><br><span class="line">        </span><br><span class="line">        if (context-&gt;bufferLength == 64) &#123;</span><br><span class="line">            SM3Compress(context, context-&gt;buffer);</span><br><span class="line">            context-&gt;bufferLength = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 处理完整块</span><br><span class="line">    while (length &gt;= 64) &#123;</span><br><span class="line">        SM3Compress(context, data);</span><br><span class="line">        data += 64;</span><br><span class="line">        length -= 64;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 缓存剩余数据</span><br><span class="line">    if (length &gt; 0) &#123;</span><br><span class="line">        memcpy(context-&gt;buffer, data, length);</span><br><span class="line">        context-&gt;bufferLength = length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 完成哈希计算</span><br><span class="line">void SM3Final(SM3Context *context, uint8_t output[32]) &#123;</span><br><span class="line">    // 计算填充长度（SM3标准：补位1 + k个0 + 64位长度）</span><br><span class="line">    size_t totalBits = context-&gt;totalLength;</span><br><span class="line">    size_t paddingBits = (context-&gt;bufferLength &lt; 56) ?</span><br><span class="line">                         (56 - context-&gt;bufferLength) :</span><br><span class="line">                         (120 - context-&gt;bufferLength);</span><br><span class="line">    </span><br><span class="line">    // 构建填充数据</span><br><span class="line">    uint8_t padding[128] = &#123;0&#125;;</span><br><span class="line">    padding[0] = 0x80; // 补位起始位（二进制10000000）</span><br><span class="line">    </span><br><span class="line">    // 添加填充</span><br><span class="line">    SM3Update(context, padding, paddingBits);</span><br><span class="line">    </span><br><span class="line">    // 添加消息长度（大端序64位）</span><br><span class="line">    uint64_t bitCount = CFSwapInt64HostToBig(totalBits);</span><br><span class="line">    SM3Update(context, (uint8_t *)&amp;bitCount, 8);</span><br><span class="line">    </span><br><span class="line">    // 确保最后一个块被处理</span><br><span class="line">    if (context-&gt;bufferLength &gt; 0) &#123;</span><br><span class="line">        memset(context-&gt;buffer + context-&gt;bufferLength, 0, 64 - context-&gt;bufferLength);</span><br><span class="line">        SM3Compress(context, context-&gt;buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 输出最终哈希（256位，大端序）</span><br><span class="line">    for (int i = 0; i &lt; 8; i++) &#123;</span><br><span class="line">        output[i*4]     = (uint8_t)(context-&gt;state[i] &gt;&gt; 24);</span><br><span class="line">        output[i*4 + 1] = (uint8_t)(context-&gt;state[i] &gt;&gt; 16);</span><br><span class="line">        output[i*4 + 2] = (uint8_t)(context-&gt;state[i] &gt;&gt; 8);</span><br><span class="line">        output[i*4 + 3] = (uint8_t)(context-&gt;state[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Objective-C 封装接口</span><br><span class="line">@implementation SM3Encryptor</span><br><span class="line"></span><br><span class="line">+ (NSData *)hashWithData:(NSData *)inputData &#123;</span><br><span class="line">    SM3Context context;</span><br><span class="line">    SM3Init(&amp;context);</span><br><span class="line">    </span><br><span class="line">    // 处理输入数据</span><br><span class="line">    SM3Update(&amp;context, inputData.bytes, inputData.length);</span><br><span class="line">    </span><br><span class="line">    // 获取结果</span><br><span class="line">    uint8_t output[32];</span><br><span class="line">    SM3Final(&amp;context, output);</span><br><span class="line">    </span><br><span class="line">    return [NSData dataWithBytes:output length:32];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (NSString *)hexStringWithData:(NSData *)inputData &#123;</span><br><span class="line">    NSData *hashData = [self hashWithData:inputData];</span><br><span class="line">    const uint8_t *bytes = (const uint8_t *)hashData.bytes;</span><br><span class="line">    NSMutableString *hex = [NSMutableString string];</span><br><span class="line">    </span><br><span class="line">    for (NSUInteger i = 0; i &lt; hashData.length; i++) &#123;</span><br><span class="line">        [hex appendFormat:@&quot;%02X&quot;, bytes[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return [hex copy];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (NSString *)hexStringWithInput:(NSString *)inputStr &#123;</span><br><span class="line">    NSData *inputData = [inputStr dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    NSData *hashData = [self hashWithData:inputData];</span><br><span class="line">    const uint8_t *bytes = (const uint8_t *)hashData.bytes;</span><br><span class="line">    NSMutableString *hex = [NSMutableString string];</span><br><span class="line">    </span><br><span class="line">    for (NSUInteger i = 0; i &lt; hashData.length; i++) &#123;</span><br><span class="line">        [hex appendFormat:@&quot;%02X&quot;, bytes[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return [hex copy];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CSM3%E2%80%9D/" rel="tag">“SM3”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CiOS%E2%80%9D/" rel="tag">“iOS”</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-gitHub-hexo-个人博客升级版"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2025/06/11/gitHub-hexo-%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E5%8D%87%E7%BA%A7%E7%89%88/"
    >gitHub hexo 个人博客升级版</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/06/11/gitHub-hexo-%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E5%8D%87%E7%BA%A7%E7%89%88/" class="article-date">
  <time datetime="2025-06-11T01:52:44.000Z" itemprop="datePublished">2025-06-11</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p>9年前自己开始学习gitHub hexo搭建个人博客，查了很多资料，最后用hexo 搭建一个个人博客，托管在gitHub上，前段时间换了一个电脑，我在新的电脑上想再发布一篇文章，才发现不行了。因为之前只在GitHub托管了hexo生成的静态文件(public)，忘记备份Hexo的源文件。<br>source&#x2F;_posts&#x2F;（所有文章）<br>_config.yml（Hexo 主配置）<br>themes&#x2F;（主题文件）<br>package.json（依赖列表）<br>如果你遇到这种情况，跟着我进入接下来的重新部署过程。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e0619df8f245">gitHub hexo 个人博客基础版</a>。</p>
<h3 id="首先确认你本地已经不存在source-x2F-posts文件夹，再查一查github是否有备份，如何远程和本地都没有，那就只能重新部署了。"><a href="#首先确认你本地已经不存在source-x2F-posts文件夹，再查一查github是否有备份，如何远程和本地都没有，那就只能重新部署了。" class="headerlink" title="首先确认你本地已经不存在source&#x2F;_posts文件夹，再查一查github是否有备份，如何远程和本地都没有，那就只能重新部署了。"></a>首先确认你本地已经不存在source&#x2F;_posts文件夹，再查一查github是否有备份，如何远程和本地都没有，那就只能重新部署了。</h3><blockquote>
<p>1.静态文件（如 public&#x2F; 下的 HTML）可通过浏览器右键「查看页面源代码」复制正文，或使用工具解析 HTML 结构。</p>
</blockquote>
<blockquote>
<p>2.使用 Markdown 渲染，HTML 中的 “article ”标签内通常包含原始文本的转换结果。</p>
</blockquote>
<blockquote>
<p>3.生成.md文件放在_posts文件夹里面。</p>
</blockquote>
<h1 id="1-备份Hexo的源文件"><a href="#1-备份Hexo的源文件" class="headerlink" title="1.备份Hexo的源文件"></a>1.备份Hexo的源文件</h1><p><strong>到这里就可以重新发布文章了，但是为了下一次不要再出现这种情况，我们需要对Hexo的源文件进行备份。</strong></p>
<p><strong>备份方式共有两种：</strong></p>
<blockquote>
<p>1.在当前gitHub管理的hexo生成的静态文件仓库中再开一个分支，用于备份Hexo的源文件。</p>
</blockquote>
<blockquote>
<p>2.单独创建一个私有仓库用于备份Hexo的源文件。</p>
</blockquote>
<p><em>因为博客需要对外展示，所以当前gitHub管理的hexo生成的静态文件仓库必须是公开的，所以如果你选择第一种方式你的原文件也只能放在公开的仓库分支。如果不想将自己的Hexo的源文件公开就可以选择第二种方式：单独创建一个私有的仓库用来备份Hexo的源文件。</em></p>
<h1 id="2-自动化"><a href="#2-自动化" class="headerlink" title="2.自动化"></a>2.自动化</h1><blockquote>
<p>上文创建完成后每次发布博客，都需要去git提交备份文件，这样太麻烦了。我们可以创建一个自动化脚本，将这些重复步骤自动化。</p>
</blockquote>
<p><strong>创建一个deploy.sh放在博客根目录：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 设置绝对路径</span><br><span class="line">BLOG_DIR=&quot;实际路径/blog&quot;</span><br><span class="line"></span><br><span class="line"># 进入博客目录</span><br><span class="line">cd &quot;$BLOG_DIR&quot; || exit 1</span><br><span class="line"></span><br><span class="line"># Hexo操作</span><br><span class="line">hexo clean</span><br><span class="line">hexo generate</span><br><span class="line">hexo deploy</span><br><span class="line"></span><br><span class="line"># 源文件备份</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;自动备份: $(date +&quot;%Y-%m-%d %H:%M&quot;)&quot;</span><br><span class="line">git push origin main</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这样一个简单的发布博客并且源文件备份的自动化脚本就好了。<br>以后每一次写完文章后再在终端进入”实际路径&#x2F;blog” 执行.&#x2F;deploy.sh 就行了</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-be565414c227becd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="执行./deploy.sh"></p>
<p><strong>首次执行需要先设置执行权限：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x deploy.sh</span><br></pre></td></tr></table></figure>

<h1 id="3-多博客自动化"><a href="#3-多博客自动化" class="headerlink" title="3.多博客自动化"></a>3.多博客自动化</h1><blockquote>
<p>当我们有多个博客需要同步是就需要对Hexo的源文件进行再次修改。</p>
</blockquote>
<p>我以github为例：</p>
<p><strong>1.首先我们的有两个GitHub账号并且本地配置好SSH</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1976231-4b672d531de2e4be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="本地SSH配置"></p>
<p><strong>2.添加配置文件</strong></p>
<h3 id="config-yml：为其中一个GitHub账号的配置"><a href="#config-yml：为其中一个GitHub账号的配置" class="headerlink" title="_config.yml：为其中一个GitHub账号的配置"></a>_config.yml：为其中一个GitHub账号的配置</h3><blockquote>
<p>url: <a target="_blank" rel="noopener" href="https://gavincarter1991.github.io/#">https://gavincarter1991.github.io#</a> 博客完整URL</p>
<p>source_dir: source  # 这个值会被脚本覆盖，但需要存在</p>
<p>public_dir: public_kind</p>
<p> <img src="https://upload-images.jianshu.io/upload_images/1976231-d4cc0887e0a1f1c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="deploy"></p>
</blockquote>
<h3 id="config-other-yml：为另外一个GitHub账号的配置"><a href="#config-other-yml：为另外一个GitHub账号的配置" class="headerlink" title="_config_other.yml：为另外一个GitHub账号的配置"></a>_config_other.yml：为另外一个GitHub账号的配置</h3><blockquote>
<p>url: <a href="https://kindyourself.github.io/">https://kindyourself.github.io</a> # 博客完整URL</p>
<p>source_dir:  &#x2F;Users&#x2F;dianyin&#x2F;Desktop&#x2F;blog&#x2F;temp_source_gavin</p>
<p>public_dir: public_gavin</p>
<p> <img src="https://upload-images.jianshu.io/upload_images/1976231-e88ac014d9ccf8ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="deploy"></p>
</blockquote>
<p>考虑到多个博客内容可能不一样：在根目录新建一个scripts文件夹创建一个JS脚本multi-site.js进行内容配置，公共文章放在source&#x2F;_posts，不同的文章各自放在自己的目录里面（source&#x2F;_posts_gavin  source&#x2F;_posts_gavin _posts_kind）脚本会分开发布。</p>
<p><strong>multi-site.js 内容：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs-extra&#x27;);</span><br><span class="line">const path = require(&#x27;path&#x27;);</span><br><span class="line">const &#123; promisify &#125; = require(&#x27;util&#x27;);</span><br><span class="line">const exec = promisify(require(&#x27;child_process&#x27;).exec);</span><br><span class="line"></span><br><span class="line">hexo.extend.filter.register(&#x27;before_generate&#x27;, async function() &#123;</span><br><span class="line">  const baseDir = hexo.base_dir;</span><br><span class="line">  const currentSite = process.env.HEXO_SITE || &#x27;kind&#x27;;</span><br><span class="line">  </span><br><span class="line">  const sites = &#123;</span><br><span class="line">    kind: &#123;</span><br><span class="line">      exclusiveDir: &#x27;source/_posts_kind&#x27;,</span><br><span class="line">      commonDir: &#x27;source/_posts&#x27;,</span><br><span class="line">      output: &#x27;public_kind&#x27;,</span><br><span class="line">      config: &#x27;_config.yml&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">    gavin: &#123;</span><br><span class="line">      exclusiveDir: &#x27;source/_posts_gavin&#x27;,</span><br><span class="line">      commonDir: &#x27;source/_posts&#x27;,</span><br><span class="line">      output: &#x27;public_gavin&#x27;,</span><br><span class="line">      config: &#x27;_config_gavin.yml&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  const site = sites[currentSite];</span><br><span class="line">  if (!site) return;</span><br><span class="line">  </span><br><span class="line">  // 创建临时源目录</span><br><span class="line">  const tempSourceDir = path.join(baseDir, `temp_source_$&#123;currentSite&#125;`);</span><br><span class="line">  fs.ensureDirSync(tempSourceDir);</span><br><span class="line">  fs.emptyDirSync(tempSourceDir);</span><br><span class="line">  </span><br><span class="line">  // 1. 复制整个source目录（包括所有共享文件）</span><br><span class="line">  fs.copySync(path.join(baseDir, &#x27;source&#x27;), tempSourceDir);</span><br><span class="line">  </span><br><span class="line">  // 2. 清空临时源目录的_posts文件夹</span><br><span class="line">  const tempPostsDir = path.join(tempSourceDir, &#x27;_posts&#x27;);</span><br><span class="line">  fs.ensureDirSync(tempPostsDir);</span><br><span class="line">  fs.emptyDirSync(tempPostsDir);</span><br><span class="line">  </span><br><span class="line">  // 3. 复制共同文章</span><br><span class="line">  const commonPosts = path.join(baseDir, site.commonDir);</span><br><span class="line">  if (fs.existsSync(commonPosts)) &#123;</span><br><span class="line">    fs.readdirSync(commonPosts).forEach(file =&gt; &#123;</span><br><span class="line">      if (file.endsWith(&#x27;.md&#x27;)) &#123;</span><br><span class="line">        fs.copySync(</span><br><span class="line">          path.join(commonPosts, file),</span><br><span class="line">          path.join(tempPostsDir, file)</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // 4. 复制专属文章</span><br><span class="line">  const exclusivePosts = path.join(baseDir, site.exclusiveDir);</span><br><span class="line">  if (fs.existsSync(exclusivePosts)) &#123;</span><br><span class="line">    fs.readdirSync(exclusivePosts).forEach(file =&gt; &#123;</span><br><span class="line">      if (file.endsWith(&#x27;.md&#x27;)) &#123;</span><br><span class="line">        fs.copySync(</span><br><span class="line">          path.join(exclusivePosts, file),</span><br><span class="line">          path.join(tempPostsDir, file)</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // 5. 动态应用配置</span><br><span class="line">  hexo.config.source_dir = tempSourceDir;</span><br><span class="line">  hexo.config.public_dir = site.output;</span><br><span class="line">  </span><br><span class="line">  // 6. 验证复制结果</span><br><span class="line">  const postCount = fs.readdirSync(tempPostsDir).length;</span><br><span class="line">  hexo.log.info(`✅ $&#123;currentSite&#125; 站点准备完成: $&#123;postCount&#125; 篇文章`);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 添加部署后清理钩子</span><br><span class="line">hexo.extend.filter.register(&#x27;after_deploy&#x27;, function() &#123;</span><br><span class="line">  const baseDir = hexo.base_dir;</span><br><span class="line">  const currentSite = process.env.HEXO_SITE;</span><br><span class="line">  </span><br><span class="line">  if (currentSite) &#123;</span><br><span class="line">    const tempSourceDir = path.join(baseDir, `temp_source_$&#123;currentSite&#125;`);</span><br><span class="line">    if (fs.existsSync(tempSourceDir)) &#123;</span><br><span class="line">      fs.removeSync(tempSourceDir);</span><br><span class="line">      hexo.log.info(`🧹 清理临时目录: $&#123;tempSourceDir&#125;`);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>当然deploy.sh也需要更改为：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line"># 配置区</span><br><span class="line">BLOG_DIR=&quot;/Users/dianyin/Desktop/blog&quot;</span><br><span class="line">SOURCE_BRANCH=&quot;master&quot;</span><br><span class="line">PRIVATE_REPO_KIND=&quot;git@github.com-kind:kindyourself/blog-source.git&quot;</span><br><span class="line">PRIVATE_REPO_GAVIN=&quot;git@github.com-gavin:gavincarter1991/blog-source.git&quot;</span><br><span class="line"></span><br><span class="line">cd &quot;$BLOG_DIR&quot; || &#123; echo &quot;❌ 无法进入博客目录&quot;; exit 1; &#125;</span><br><span class="line"></span><br><span class="line"># 清理上次生成的临时文件</span><br><span class="line">rm -rf temp_source_* public*</span><br><span class="line">hexo clean</span><br><span class="line"></span><br><span class="line"># 生成 Kind 站点</span><br><span class="line">echo &quot;===== 🚀 生成 Kind 站点 =====&quot;</span><br><span class="line">export HEXO_SITE=&quot;kind&quot;</span><br><span class="line">hexo generate --config _config.yml</span><br><span class="line"></span><br><span class="line"># 验证生成结果</span><br><span class="line">echo &quot;Kind 站点内容:&quot;</span><br><span class="line">ls -lh public_kind</span><br><span class="line">tree -L 2 public_kind | head -20</span><br><span class="line"></span><br><span class="line"># 生成 Gavin 站点</span><br><span class="line">echo &quot;===== 🚀 生成 Gavin 站点 =====&quot;</span><br><span class="line">export HEXO_SITE=&quot;gavin&quot;</span><br><span class="line">hexo generate --config _config_gavin.yml</span><br><span class="line"></span><br><span class="line"># 验证生成结果</span><br><span class="line">echo &quot;Gavin 站点内容:&quot;</span><br><span class="line">ls -lh public_gavin</span><br><span class="line">tree -L 2 public_gavin | head -20</span><br><span class="line"></span><br><span class="line"># 部署到GitHub Pages</span><br><span class="line">echo &quot;===== 🚀 部署到 GitHub Pages =====&quot;</span><br><span class="line">echo &quot;部署 Kind 站点...&quot;</span><br><span class="line">export HEXO_SITE=&quot;kind&quot;</span><br><span class="line">hexo deploy --config _config.yml</span><br><span class="line"></span><br><span class="line">echo &quot;部署 Gavin 站点...&quot;</span><br><span class="line">export HEXO_SITE=&quot;gavin&quot;</span><br><span class="line">hexo deploy --config _config_gavin.yml</span><br><span class="line"></span><br><span class="line"># 备份到私有仓库</span><br><span class="line">echo &quot;===== 📦 备份源文件到私有仓库 =====&quot;</span><br><span class="line">git add .</span><br><span class="line">if git diff-index --quiet HEAD --; then</span><br><span class="line">    echo &quot;🔄 无文件变更&quot;</span><br><span class="line">else</span><br><span class="line">    git commit -m &quot;自动备份: $(date +&quot;%Y-%m-%d %H:%M:%S&quot;)&quot;</span><br><span class="line">    </span><br><span class="line">    # 推送到两个私有仓库</span><br><span class="line">    git push &quot;$PRIVATE_REPO_KIND&quot; &quot;$SOURCE_BRANCH&quot; &amp;&amp; \</span><br><span class="line">        echo &quot;✅ kindyourself/blog-source 备份成功&quot; || \</span><br><span class="line">        echo &quot;❌ kindyourself/blog-source 备份失败&quot;</span><br><span class="line">    </span><br><span class="line">    git push &quot;$PRIVATE_REPO_GAVIN&quot; &quot;$SOURCE_BRANCH&quot; &amp;&amp; \</span><br><span class="line">        echo &quot;✅ gavincarter1991/blog-source 备份成功&quot; || \</span><br><span class="line">        echo &quot;❌ gavincarter1991/blog-source 备份失败&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;===== ✅ 部署完成 =====&quot;</span><br><span class="line">echo &quot;博客地址1: https://kindyourself.github.io&quot;</span><br><span class="line">echo &quot;博客地址2: https://gavincarter1991.github.io&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>以上就是gitHub hexo 个人博客升级版</strong></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CHexo%E2%80%9D/" rel="tag">“Hexo”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9Cgithub/" rel="tag">“github&quot;</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9C%E5%8D%9A%E5%AE%A2/" rel="tag">“博客&quot;</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-widget-advanced"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2025/06/07/widget-advanced/"
    >Widget进阶</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/06/07/widget-advanced/" class="article-date">
  <time datetime="2025-06-07T12:17:56.000Z" itemprop="datePublished">2025-06-07</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Flutter/">Flutter</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="1-Widget-介绍"><a href="#1-Widget-介绍" class="headerlink" title="1.Widget 介绍"></a>1.Widget 介绍</h2><blockquote>
<p>Everything is a widget 这是你学习 flutter 会听到的最多的一句话。因为在 Flutter 中几乎所有的对象都是一个 widget，在 flutter 中 UI 的构建和事件的处理基本都是通过 widget 的组合及嵌套来完成的。在 iOS 中我们经常提及的“组件”、“控件”在 flutter 中就是 widget，当然 widget 的范围比之更加广泛。如：手势检测 GestureDetector、主题 Theme 和动画容器 AnimatedContainer 等也是 widget。</p>
</blockquote>
<p><strong>Flutter 默认支持的两种设计风格：</strong></p>
<blockquote>
<p><strong>1.Material components Design：</strong> 谷歌（android）的 UI 风格，主要为 Android 设计，但也支持跨平台使用。</p>
</blockquote>
<blockquote>
<p><strong>2.Cupertino Design：</strong> 苹果（iOS）的 UI 风格，模仿苹果原生 UIKit 风格。高度还原 iOS 原生体验，适合需要与苹果生态一致的应用。</p>
</blockquote>
<h2 id="2-Widget-分类"><a href="#2-Widget-分类" class="headerlink" title="2.Widget 分类"></a>2.Widget 分类</h2><p><strong><em>1.按状态管理</em></strong></p>
<h6 id="一、StatelessWidget："><a href="#一、StatelessWidget：" class="headerlink" title="一、StatelessWidget："></a>一、StatelessWidget：</h6><p>无状态组件，通过 build 方法返回静态 UI。不可变，属性（final）在创建后无法修改，适用于不需要内部状态变化的场景（如文本显示、图标），不依赖用户交互或数据变化的 UI 部分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">class IconTextButton extends StatelessWidget &#123;</span><br><span class="line">  final String iconName;</span><br><span class="line">  final String label;</span><br><span class="line">  final VoidCallback onPressed;</span><br><span class="line"></span><br><span class="line">  const IconTextButton(&#123;</span><br><span class="line">    super.key,</span><br><span class="line">    required this.iconName,</span><br><span class="line">    required this.label,</span><br><span class="line">    required this.onPressed,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return GestureDetector(</span><br><span class="line">      onTap: onPressed,</span><br><span class="line">      child: Column(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          Image.asset(</span><br><span class="line">            &quot;assets/images/$iconName.png&quot;,</span><br><span class="line">            width: 40,</span><br><span class="line">            height: 40,</span><br><span class="line">          ),</span><br><span class="line">          const SizedBox(</span><br><span class="line">            height: 10,</span><br><span class="line">          ), // 图标</span><br><span class="line">          Text(</span><br><span class="line">            label,</span><br><span class="line">            style: const TextStyle(color: ColorConstant.color33, fontSize: 10),</span><br><span class="line">          ), // 文字</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="二、StatefulWidget："><a href="#二、StatefulWidget：" class="headerlink" title="二、StatefulWidget："></a>二、StatefulWidget：</h6><p>有状态组件，通过 State 对象管理动态数据。当状态变化时调用 setState 触发 UI 更新，需要用户交互（如按钮点击、表单输入）和依赖实时数据变化（如计数器、动态列表）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">// 上下滚动的消息轮播</span><br><span class="line">class MarqueeWidget extends StatefulWidget &#123;</span><br><span class="line">  /// 子视图数量</span><br><span class="line">  final int count;</span><br><span class="line"></span><br><span class="line">  ///子视图构建器</span><br><span class="line">  final IndexedWidgetBuilder itemBuilder;</span><br><span class="line"></span><br><span class="line">  ///轮播的时间间隔</span><br><span class="line">  final int loopSeconds;</span><br><span class="line"></span><br><span class="line">  const MarqueeWidget(&#123;</span><br><span class="line">    super.key,</span><br><span class="line">    required this.count,</span><br><span class="line">    required this.itemBuilder,</span><br><span class="line">    this.loopSeconds = 5,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  _MarqueeWidgetState createState() =&gt; _MarqueeWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class _MarqueeWidgetState extends State&lt;MarqueeWidget&gt; &#123;</span><br><span class="line">  late PageController _controller;</span><br><span class="line">  late Timer _timer;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  void initState() &#123;</span><br><span class="line">    super.initState();</span><br><span class="line">    _controller = PageController();</span><br><span class="line">    _timer = Timer.periodic(Duration(seconds: widget.loopSeconds), (timer) &#123;</span><br><span class="line">      if (_controller.page != null) &#123;</span><br><span class="line">        // 如果当前位于最后一页，则直接跳转到第一页，两者内容相同，跳转时视觉上无感知</span><br><span class="line">        if (_controller.page!.round() &gt;= widget.count) &#123;</span><br><span class="line">          _controller.jumpToPage(0);</span><br><span class="line">        &#125;</span><br><span class="line">        _controller.nextPage(</span><br><span class="line">            duration: const Duration(seconds: 1), curve: Curves.linear);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return PageView.builder(</span><br><span class="line">      scrollDirection: Axis.vertical,</span><br><span class="line">      controller: _controller,</span><br><span class="line">      itemBuilder: (buildContext, index) &#123;</span><br><span class="line">        if (index &lt; widget.count) &#123;</span><br><span class="line">          return widget.itemBuilder(buildContext, index);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          return widget.itemBuilder(buildContext, 0);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      itemCount: widget.count + 1,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  void dispose() &#123;</span><br><span class="line">    super.dispose();</span><br><span class="line">    _controller.dispose();</span><br><span class="line">    _timer.cancel();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><em>2.按功能分类</em></strong></p>
<blockquote>
<p><strong>1.布局类 Widget：</strong> 控制子 Widget 的排列方式。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">常见有：</span><br><span class="line">Row/Column：水平/垂直排列子项（基于 Flexbox）。</span><br><span class="line">Stack：子 Widget 堆叠（类似 CSS 的绝对定位）。</span><br><span class="line">Expanded/Flexible：在 Row 或 Column 中分配剩余空间。</span><br><span class="line">Container：结合布局、装饰、边距等功能</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>2.基础组件 Widget：</strong> 构成 UI 的基本元素。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">常见有：</span><br><span class="line">Text：显示文本。</span><br><span class="line">Image：加载本地或网络图片。</span><br><span class="line">Icon：显示图标（需引入 cupertino_icons 或自定义图标库）</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>3.滚动类 Widget：</strong> 处理内容超出屏幕时的滚动行为。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">常见有：</span><br><span class="line">ListView：垂直/水平滚动列表。</span><br><span class="line">GridView：网格布局滚动视图。</span><br><span class="line">SingleChildScrollView：包裹单个可滚动子组件。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>4.交互类 Widget：</strong> 响应用户输入事件。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">常见有：</span><br><span class="line">ElevatedButton/TextButton：按钮交互。</span><br><span class="line">TextField：文本输入框。</span><br><span class="line">Checkbox/Switch：选择控件。</span><br><span class="line">GestureDetector：自定义手势检测（点击、长按、拖动）。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>5.平台风格类 Widget：</strong> 适配不同操作系统的视觉风格。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">常见有：</span><br><span class="line">Material Design：MaterialApp、AppBar、FloatingActionButton。</span><br><span class="line">Cupertino（iOS 风格）：CupertinoApp、CupertinoNavigationBar、CupertinoPicker。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>6.动画类 Widget：</strong> 实现动态视觉效果。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">常见有：</span><br><span class="line">AnimatedContainer：自动过渡的容器（大小、颜色等属性变化）。</span><br><span class="line">Hero：页面切换共享元素的过渡动画。</span><br><span class="line">AnimatedBuilder：自定义复杂动画。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>7. 导航与路由类 Widget：</strong> 管理页面跳转和导航结构。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">常见有：</span><br><span class="line">Navigator：管理页面堆栈（push/pop）。</span><br><span class="line">PageView：实现滑动切换页面。</span><br><span class="line">BottomNavigationBar：底部导航栏。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过简单 Widget 组合实现复杂 UI（例如用 Row + Expanded 替代自定义布局）(优先组合而非继承)<br>局部状态使用 StatefulWidget<br>全局状态使用状态管理工具（如 Provider、Riverpod）<br>对频繁更新的部分使用 const 构造函数<br>长列表使用 ListView.builder 懒加载</p>
</blockquote>
<h2 id="3-Widget-生命周期"><a href="#3-Widget-生命周期" class="headerlink" title="3.Widget 生命周期"></a>3.Widget 生命周期</h2><p><strong>StatelessWidget 的生命周期</strong></p>
<blockquote>
<p>StatelessWidget 仅有一个 build() 方法，无状态管理逻辑，其生命周期完全由父组件控制。</p>
</blockquote>
<p><strong>StatefulWidget 主要生命周期方法</strong></p>
<blockquote>
<p>创建阶段<br>createState()</p>
</blockquote>
<blockquote>
<p>初始化阶段<br>initState()<br>didChangeDependencies()</p>
</blockquote>
<blockquote>
<p>更新阶段<br>didUpdateWidget(oldWidget)<br>build()</p>
</blockquote>
<blockquote>
<p>销毁阶段<br>deactivate()<br>dispose()</p>
</blockquote>
<p><img src="https://i-blog.csdnimg.cn/img_convert/a33469c55f94b5278f698d8605d8e0cc.webp?x-oss-process=image/format,png" alt="2025-05-22 18.38.22.png"></p>
<p><strong>1.createState()</strong><br>当 StatefulWidget 被插入 Widget 树时调用，而且只执行一次。</p>
<blockquote>
<p>主要用于创建与之关联的 State 对象（每个 Widget 对应一个 State 实例）。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class MyWidget extends StatefulWidget &#123;</span><br><span class="line">  @override</span><br><span class="line">  _MyWidgetState createState() =&gt; _MyWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.initState()</strong><br>在 State 对象创建后，首次调用 build() 之前触发该方法，而且只执行一次。</p>
<blockquote>
<p>主要用于初始化依赖数据（如订阅事件、加载本地配置）和 创建动画控制器（AnimationController）等需与 dispose() 配对的资源。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@override</span><br><span class="line">void initState() &#123;</span><br><span class="line">  super.initState();</span><br><span class="line">  _controller = AnimationController(vsync: this);</span><br><span class="line">  _fetchData(); // 初始化数据</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要注意的是：<br><code>必须调用 super.initState()。</code><br><code>在这里 View 并没有渲染，只是 StatefulWidget 被加载到渲染树里了。</code><br><code>避免在此处触发 setState（可能导致渲染未完成）。</code><br><code>StatefulWidget的 mount 的值变为了true（调用dispose()才会变为 false）。</code></p>
<p><strong>3.didChangeDependencies()</strong><br>initState() 后立即调用 didChangeDependencies()。<br>当 State 依赖的 InheritedWidget 发生变化时（如主题、本地化）也会调用 didChangeDependencies()。</p>
<blockquote>
<p>主要用于处理依赖变化后的逻辑（如重新请求网络数据）。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@override</span><br><span class="line">void didChangeDependencies() &#123;</span><br><span class="line">  super.didChangeDependencies();</span><br><span class="line">  if (Provider.of&lt;Data&gt;(context).hasChanged) &#123;</span><br><span class="line">    _updateData();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>4. didUpdateWidget(oldWidget)</strong><br>在父组件重建时，若新旧 Widget 的 runtimeType 和 key 相同触发 didUpdateWidget（didUpdateWidget 我们一般不会用到）。</p>
<blockquote>
<p>主要是：<br>对比新旧 Widget 的配置（如属性变化）。<br>根据变化调整状态（如重置动画、更新监听）。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@override</span><br><span class="line">void didUpdateWidget(MyWidget oldWidget) &#123;</span><br><span class="line">  super.didUpdateWidget(oldWidget);</span><br><span class="line">  if (oldWidget.color != widget.color) &#123;</span><br><span class="line">    _updateColor(); // 颜色变化时执行逻辑</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>5. build()</strong><br>初始化后、依赖变化后、setState() 调用后调用 build()。<br>父组件或祖先组件触发重建时调用 build()。</p>
<blockquote>
<p>主要是根据当前状态构建 UI（不要在这里做除了创建 Widget 之外的操作）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@override</span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  return Container(</span><br><span class="line">    color: widget.color,</span><br><span class="line">    child: Text(&#x27;Count: $_count&#x27;),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要注意的是：<br><code>必须返回一个 Widget</code><br><code>避免在此处修改状态或执行耗时操作</code></p>
<p><strong>6. deactivate()</strong><br>当 State 从树中暂时移除（如页面切换、组件被移除）触发 deactivate()。</p>
<blockquote>
<p>清理临时资源或保存临时状态.</p>
</blockquote>
<p>需要注意的是：<br><code>可能被重新插入树中（如页面返回时），需与 dispose() 区分</code></p>
<p><strong>7. dispose()</strong><br>State 被永久移除时调用 dispose()。</p>
<blockquote>
<p>释放资源（如取消网络请求、销毁动画控制器）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@override</span><br><span class="line">void dispose() &#123;</span><br><span class="line">  _controller.dispose(); // 销毁动画控制器</span><br><span class="line">  _subscription.cancel(); // 取消事件订阅</span><br><span class="line">  super.dispose();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要注意的是：<br><code>如果在 dispose() 中未释放资源（如动画控制器、Stream 订阅）可能造成内存泄漏</code><br><code>如果在 dispose() 后调用 setState 会导致异常</code></p>
<h2 id="4-Widget-的渲染"><a href="#4-Widget-的渲染" class="headerlink" title="4.Widget 的渲染"></a>4.Widget 的渲染</h2><p><strong>渲染流程：</strong><br>Flutter 的渲染系统基于三棵核心树结构，通过高度优化的管线（Pipeline）实现高效的 UI 更新。</p>
<blockquote>
<p><strong>Widget 重建 → Diff 新旧 Widget 树 → 更新 Element 树 → 更新 RenderObject 树 → 触发 Layer 合成 → 屏幕刷新</strong></p>
</blockquote>
<p><strong>1.Widget 树的构建：</strong></p>
<blockquote>
<p>描述 UI 的不可变配置，由开发者创建，频繁重建，需轻量化。<br>开发者编写的 Widget 代码被转化为嵌套的 Widget 树（应用的入口是根 Widget，一般是 MaterialApp 或 CupertinoApp。根 Widget 会递归地构建其子 Widget，形成一棵树。）。<br>具有不可变性，每次重建生成全新的 Widget 树，但通过 Diff 算法可以优化实际更新范围。</p>
</blockquote>
<p><strong>2. Element 树的 Diff 与更新</strong></p>
<blockquote>
<p>根据 Widget 树生成一个 Element 树，Element 树中的节点都继承自 Element 类。<br>Element 是 Widget 的实例化对象，负责管理 状态（State） 和 子节点引用。<br>每个 Widget 都会有一个对应的 Element 对象，用于管理其生命周期。</p>
</blockquote>
<blockquote>
<p>Diff 算法：Flutter 对比新旧 Widget 树，仅更新变化的 Element 和 RenderObject，类似 React 的虚拟 DOM。<br>当 Widget 树重建时，Flutter 通过 Diff 算法 对比新旧 Widget 树，决定 Element 树的更新策略<br>Reuse：若新旧 Widget 的 runtimeType 和 key 相同，复用现有 Element。<br>Update：更新 Element 的配置（调用 Element.update(newWidget)）。<br>Replace：类型或 Key 不同时，销毁旧 Element，创建新 Element。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 旧 Widget 树</span><br><span class="line">Container(color: Colors.red)</span><br><span class="line"></span><br><span class="line">// 新 Widget 树</span><br><span class="line">Container(color: Colors.blue)</span><br><span class="line"></span><br><span class="line">// Diff 结果：Container 类型相同且无 Key → 复用 Element，更新 RenderObject 颜色</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// Element 更新逻辑</span><br><span class="line">Element.updateChild()</span><br><span class="line"></span><br><span class="line">Element updateChild(Element child, Widget newWidget, dynamic newSlot) &#123;</span><br><span class="line">  if (newWidget == null) &#123;</span><br><span class="line">    // 移除子节点</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br><span class="line">  if (child != null) &#123;</span><br><span class="line">    if (child.widget == newWidget) &#123;</span><br><span class="line">      // Widget 未变化 → 复用 Element</span><br><span class="line">      return child;</span><br><span class="line">    &#125;</span><br><span class="line">    if (Widget.canUpdate(child.widget, newWidget)) &#123;</span><br><span class="line">      // 更新 Element 配置</span><br><span class="line">      child.update(newWidget);</span><br><span class="line">      return child;</span><br><span class="line">    &#125;</span><br><span class="line">    // 销毁旧 Element，创建新 Element</span><br><span class="line">    deactivateChild(child);</span><br><span class="line">  &#125;</span><br><span class="line">  return inflateWidget(newWidget, newSlot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>3. RenderObject 树的更新</strong></p>
<p>更新 RenderObject 树，计算布局和生成绘制指令。<br>运行在 UI Thread。</p>
<blockquote>
<p>根据 Element 树生成 Render 树（渲染树），渲染树中的节点都继承自 RenderObject 类。<br>每个 Element 对应一个 RenderObject（通过 Element.createRenderObject() 创建）。</p>
</blockquote>
<blockquote>
<p>根据父 RenderObject 传递的 约束（Constraints），计算自身尺寸和位置。<br>递归调用子节点的 layout() 方法（深度优先遍历）。</p>
</blockquote>
<p><strong>布局（Layout）核心方法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// RenderObject 布局流程</span><br><span class="line">RenderObject.layout()</span><br><span class="line"></span><br><span class="line">void layout(Constraints constraints, &#123; bool parentUsesSize = false &#125;) &#123;</span><br><span class="line">  _constraints = constraints;</span><br><span class="line">  if (_relayoutBoundary != this) &#123;</span><br><span class="line">    markNeedsLayout();</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">  performLayout();  // 1. 计算自身尺寸（调用 performLayout） 由子类实现具体布局逻辑</span><br><span class="line">  _needsLayout = false;</span><br><span class="line">  markNeedsPaint(); // 标记需要重绘</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>生成绘制指令（如形状、颜色、文本），写入 Layer（合成层）。</p>
</blockquote>
<p><strong>绘制（Paint）核心方法:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void paint(PaintingContext context, Offset offset) &#123;</span><br><span class="line">  // 绘制逻辑，如画矩形</span><br><span class="line">  context.canvas.drawRect(rect, paint);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>4. 合成与光栅化（Composition &amp; Rasterization）</strong></p>
<p>生成 Layer 树并光栅化。<br>运行在 Raster Thread（与 UI Thread 并行）</p>
<blockquote>
<p>根据渲染树生成 Layer 树，然后上屏显示，Layer 树中的节点都继承自 Layer 类。<br>RenderObject 的绘制结果被组织为 Layer 树，每个 Layer 对应一个 GPU 纹理（Texture）。自此 Layer 树生成。<br>类型包括：PictureLayer（矢量绘制）、TextureLayer（图像纹理）、TransformLayer（变换效果）等。</p>
</blockquote>
<blockquote>
<p>将 Layer 树中的绘制指令转换为 GPU 可识别的位图数据。<br>通过 Skia 图形库（或 Impeller）完成，最终提交给 GPU 渲染。（完成光栅化（Raster Thread））。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void paintChild(RenderObject child, Offset offset) &#123;</span><br><span class="line">  if (child.isRepaintBoundary) &#123;</span><br><span class="line">    // 创建独立 Layer</span><br><span class="line">    stopRecordingIfNeeded();</span><br><span class="line">    child._layer = OffsetLayer();</span><br><span class="line">    appendLayer(child._layer);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    child._paintWithContext(this, offset);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>5. GPU 渲染与屏幕刷新</strong></p>
<blockquote>
<p><strong>垂直同步（VSync）：</strong><br>由系统定时触发的信号，控制帧率（如 60Hz → 16.6ms&#x2F;帧）。<br>Flutter 引擎在 VSync 信号到来时，提交光栅化后的帧数据到 GPU。</p>
</blockquote>
<blockquote>
<p><strong>屏幕显示：</strong><br>GPU 将帧数据写入帧缓冲区（Frame Buffer），屏幕硬件按刷新率读取并显示。</p>
</blockquote>
<h2 id="5-Widget-优化"><a href="#5-Widget-优化" class="headerlink" title="5.Widget 优化"></a>5.Widget 优化</h2><p><code>高性能渲染 = 最小化 Widget Diff + 高效布局/绘制 + GPU 线程优化</code></p>
<blockquote>
<p>Flutter 优化的本质是 减少无效计算 和 降低 GPU 负载<br>一般围绕四个方向： 1.最小化 Widget 树 Diff 范围 2.减少布局（Layout）和绘制（Paint）计算 3.优化 GPU 合成与光栅化（Rasterization） 4.高效管理状态与资源</p>
</blockquote>
<blockquote>
<p><strong>性能分析工具</strong><br>Flutter DevTools：<br>Performance 面板：分析 UI&#x2F;Raster 线程的帧耗时。<br>Layer 查看器：检测 Layer 合成是否合理。<br>debugProfileBuildsEnabled：追踪 Widget 构建耗时<br>调试标记：<br>debugPrintMarkNeedsLayoutStacks：打印触发布局的堆栈信息。<br>debugPaintLayerBordersEnabled：可视化 Layer 边界。</p>
</blockquote>
<p><strong>1.Widget 树 Diff 优化</strong></p>
<blockquote>
<p><strong>Diff 算法机制：</strong> 当父组件更新时，Flutter 递归对比新旧 Widget 树，判断是否需要更新 Element 和 RenderObject。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static bool canUpdate(Widget oldWidget, Widget newWidget) &#123;</span><br><span class="line">  return oldWidget.runtimeType == newWidget.runtimeType</span><br><span class="line">      &amp;&amp; oldWidget.key == newWidget.key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>复用条件：</strong> runtimeType 和 key 相同 → 复用 Element，仅更新配置。<br><strong>替换条件：</strong> 类型或 Key 不同 → 销毁旧 Element，创建新 Element。</p>
</blockquote>
<p><strong>优化策略：</strong><br><strong>1.使用 const 构造函数：</strong> const Widget 在多次重建中引用同一内存地址，Widget.canUpdate 直接返回 true，跳过 Diff 计算。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const MyWidget(text: &#x27;Hello&#x27;); // ✅ 优化</span><br><span class="line">MyWidget(text: &#x27;Hello&#x27;);      // ❌ 非 const</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.合理使用 Key：</strong> ValueKey：在列表项中标识唯一性，避免错误复用导致状态混乱。<br>GlobalKey：跨组件访问状态（谨慎使用，破坏局部性）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ListView.builder(</span><br><span class="line">  itemBuilder: (_, index) =&gt; ItemWidget(</span><br><span class="line">    key: ValueKey(items[index].id), // 唯一标识</span><br><span class="line">    data: items[index],</span><br><span class="line">  ),</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>3.拆分细粒度 Widget：</strong> 将频繁变化的部分拆分为独立 Widget，缩小 setState 触发的 Diff 范围。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 父组件（仅传递静态数据）</span><br><span class="line">class ParentWidget extends StatelessWidget &#123;</span><br><span class="line">  const ParentWidget(&#123;super.key&#125;);</span><br><span class="line">  @override</span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    return Column(</span><br><span class="line">      children: [</span><br><span class="line">        const StaticHeader(), // 静态部分</span><br><span class="line">        DynamicContent(data: _data), // 动态部分</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>2.布局（Layout）阶段优化</strong></p>
<blockquote>
<p><strong>布局计算机制：</strong> 当某个 RenderObject 的尺寸变化不影响父节点布局时，可标记为布局边界，阻断布局计算向上传播。通过 RenderObject.isRepaintBoundary &#x3D; true 设置（布局边界（Relayout Boundary））</p>
</blockquote>
<blockquote>
<p>父节点传递 约束（Constraints） 给子节点<br>子节点根据约束计算自身尺寸，并递归布局子节点(布局过程)</p>
</blockquote>
<p><strong>优化策略</strong></p>
<blockquote>
<p><strong>1.避免过度嵌套：</strong> 多层 Row&#x2F;Column 会导致布局计算复杂度呈指数增长。<br>我们可以使用 Flex、Wrap 或自定义布局逻辑替代嵌套。</p>
</blockquote>
<blockquote>
<p><strong>2.预计算尺寸：</strong> 通过固定尺寸（SizedBox）或 LayoutBuilder 提前确定布局约束，减少计算量。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SizedBox(</span><br><span class="line">  width: 100,</span><br><span class="line">  height: 50,</span><br><span class="line">  child: Text(&#x27;Fixed Size&#x27;),</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>3.使用 IntrinsicWidth&#x2F;IntrinsicHeight 的替代方案：</strong> IntrinsicWidth 会触发多次子节点布局计算，性能低下。<br>我们可以手动计算子节点最大宽度，使用 ConstrainedBox 限制尺寸。</p>
</blockquote>
<p><strong>3.绘制（Paint）阶段优化</strong></p>
<blockquote>
<p><strong>绘制机制：</strong> 当 RenderObject 的视觉属性（如颜色、位置）变化时，调用 markNeedsPaint() 标记需要重绘。</p>
</blockquote>
<blockquote>
<p><strong>合成层（Layer）：</strong> 每个 RenderObject 的绘制结果被组织为 Layer 树，最终由 GPU 光栅化。（PictureLayer（矢量绘制）、TextureLayer（图像）、TransformLayer（变换））。</p>
</blockquote>
<p><strong>优化策略</strong></p>
<blockquote>
<p><strong>1.使用 RepaintBoundary：</strong> 将独立变化的 UI 部分包裹 RepaintBoundary，生成独立 Layer，减少重绘区域。<br>通过 RenderObject.isRepaintBoundary &#x3D; true 标记。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RepaintBoundary(</span><br><span class="line">  child: MyAnimatedWidget(), // 独立重绘区域</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>2.避免高开销绘制操作：</strong> 使用 AnimatedOpacity 或直接设置颜色透明度（Color.withOpacity）替代 Opacity 。<br>优先使用 ClipRect 或 ClipRRect，减少路径裁剪的计算量。</p>
</blockquote>
<blockquote>
<p><strong>3.自定义绘制优化：</strong> 在 CustomPainter 中精确控制重绘条件。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class MyPainter extends CustomPainter &#123;</span><br><span class="line">  @override</span><br><span class="line">  bool shouldRepaint(MyPainter old) &#123;</span><br><span class="line">    return old.color != color; // 仅颜色变化时重绘</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>4.GPU 合成与光栅化优化</strong></p>
<blockquote>
<p><strong>1.光栅化机制：</strong> 通过上面的合成与光栅化可知道：光栅化运行在独立的 Raster Thread，与 UI Thread 并行。<br>Flutter 自动复用未变化的 Layer 对应的 GPU 纹理，减少数据传输。（纹理（Texture）复用）</p>
</blockquote>
<p><strong>优化策略</strong></p>
<blockquote>
<p><strong>1.减少 Layer 数量：</strong> 过多的 Layer 会增加 GPU 合成开销，我们需要尽可能的合并相邻的 PictureLayer，避免不必要的 Opacity 或 Transform 嵌套。</p>
</blockquote>
<blockquote>
<p><strong>2.使用硬件加速操作：</strong> 利用 GPU 的矩阵变换硬件加速（Transform 替代手动矩阵计算）。<br>对重复使用的图片提前解码（precacheImage） （Image 预加载）。</p>
</blockquote>
<blockquote>
<p><strong>3.启用 Impeller 引擎：</strong> Flutter 3.0+ 引入的 Impeller 引擎针对 GPU 负载优化，减少光栅化抖动。</p>
</blockquote>
<p><strong>5.状态管理与资源优化</strong></p>
<blockquote>
<p><strong>1.状态管理：</strong><br>局部状态：使用 StatefulWidget 管理，确保 dispose() 释放资源。<br>全局状态：采用 Provider、Riverpod 或 Bloc，避免状态穿透和冗余重建。</p>
</blockquote>
<blockquote>
<p><strong>2.资源释放：</strong><br>必须释放动画控制器（AnimationController.dispose()）、Stream 订阅（Subscription.cancel()）等资源。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@override</span><br><span class="line">void dispose() &#123;</span><br><span class="line">  _controller.dispose();</span><br><span class="line">  _streamSubscription.cancel();</span><br><span class="line">  super.dispose();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://i-blog.csdnimg.cn/img_convert/58ae194fbfc28292a73f2130d949f78a.webp?x-oss-process=image/format,png" alt="2025-05-23 14.45.52.png"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CFlutter%E2%80%9D/" rel="tag">“Flutter”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CWidget%E2%80%9D/" rel="tag">“Widget”</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-flutter-error"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2025/05/23/flutter-error/"
    >Flutter遇到的问题</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2025/05/23/flutter-error/" class="article-date">
  <time datetime="2025-05-23T07:17:44.000Z" itemprop="datePublished">2025-05-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Flutter/">Flutter</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p><strong>1.Flutter In ios 14+,debug mode Flutter apps can only be launched from Flutter tooling。<br>原因：Debug模式下，Flutter也实现了热重载，默认编译方式为JIT而iOS 14+系统对这种编译模式做了限制，导致无法启动。</strong></p>
</blockquote>
<p>解决办法如下：用 [Xcode] 打开Flutter里面Runner工程项目，在 Build Settings 的最下方找到 User-Defined，点击 + 按钮，添加一个键为 FLUTTER_BUILD_MODE ，debug设置profile模式，release设置release 模式：<img src="https://i-blog.csdnimg.cn/img_convert/7f789a7b66202aa3d5d577d4ff7a4b51.webp?x-oss-process=image/format,png" alt="截屏2024-03-14 11.27.00.png">{target&#x3D;”_blank”}</p>
<blockquote>
<p><strong>2.将 flutter 模块 嵌入iOS工程中，编译时报错：Failed to package 。。。。flutter代码路径。。。。。Command PhaseScriptExecution failed with a nonzero exit code</strong><br><img src="https://i-blog.csdnimg.cn/img_convert/ad21f4b3e2a82eb701e1e9363f00d885.webp?x-oss-process=image/format,png" alt="截屏2024-03-14 11.28.18.png">{target&#x3D;”_blank”}</p>
</blockquote>
<p>解决办法如下：<br><strong>1.确保flutter项目代码中没有错误</strong><br><strong>2.重新构建项目：</strong><br><strong>flutter clean</strong><br><strong>2.flutter pub get（获取远程库,确定当前应用所依赖的包，并将它们保存到中央系统缓存（central system cache）中）</strong><br><strong>3.flutter run</strong></p>
<blockquote>
<p><strong>3.升级flutter：flutter upgrade –force 报错</strong><br><img src="https://i-blog.csdnimg.cn/img_convert/ed59f544c4becaac4c167e3128af66ca.webp?x-oss-process=image/format,png" alt="截屏2024-09-12 15.23.05.png">{target&#x3D;”_blank”}</p>
</blockquote>
<p>Flutter Channel版本选择<br>Flutter提供了Stable、Beta、Dev和Master四种版本，每种版本都有其特定的用途和稳定性：<br>Stable：最稳定的版本，推荐用于生产环境。<br>Beta：相对较稳定，但仍可能存在一些已知问题。<br>Dev：经过Google测试后的最新版本，包含新功能和改进。<br>Master：最新的代码主分支，更新速度非常快，几乎每天都有提交，新功能多但可能不稳定。<br>开发Flutter项目时，一般推荐使用Stable版本，以确保项目的稳定性和可靠性。如需使用某些尚未在Stable版本中支持的功能，可以考虑使用Beta或Dev版本。Master版本则更适合于那些希望尝试最新功能并愿意承受潜在不稳定性的开发者。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CError%E2%80%9D/" rel="tag">“Error”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CFlutter%E2%80%9D/" rel="tag">“Flutter”</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-项目剖析04-swift-网络请求Moya-Alamofire-HTTPS-证书验证"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2024/03/05/%E9%A1%B9%E7%9B%AE%E5%89%96%E6%9E%9004-swift-%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82Moya-Alamofire-HTTPS-%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81/"
    >项目剖析04-swift 网络请求Moya+Alamofire(HTTPS)证书验证</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/03/05/%E9%A1%B9%E7%9B%AE%E5%89%96%E6%9E%9004-swift-%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82Moya-Alamofire-HTTPS-%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81/" class="article-date">
  <time datetime="2024-03-05T08:02:13.000Z" itemprop="datePublished">2024-03-05</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/swift/">swift</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="SSL证书验证"><a href="#SSL证书验证" class="headerlink" title="SSL证书验证"></a>SSL证书验证</h2><p><strong>一种加强App 和 Server 间通讯安全的方法。主要目标是确保 App 仅与预先验证的 Server 建立安全连接，防止中间人攻击（Man-in-the-Middle，MitM）等安全风险。一般常用的有两种方式进行验证，Certificate Pinning和Public Key Pinning。</strong></p>
<blockquote>
<p>Alamofire5.0 以后将证书验证类放于ServerTrustEvaluation这个类里面。一共有6种验证策略：</p>
<ol>
<li><p><strong>DefaultTrustEvaluator</strong> - （默认验证策略）只要是合法证书就能通过验证。</p>
</li>
<li><p><strong>RevocationTrustEvaluator</strong>（验证注销策略）对注销证书做的一种额外设置，Alamofire从iOS10.1才开始支持吊销证书的策略。</p>
</li>
<li><p><strong>PinnedCertificatesTrustEvaluator</strong>（证书验证策略）app端会对服务器端返回的证书和本地保存的证书中的全部内容进行校验需要全部正确，此验证策略还可以接受自签名证书，安全性相对较高，此方法较为固定，如果 Server 更新证书，App 需要定期更新并重新上架。</p>
</li>
<li><p><strong>PublicKeysTrustEvaluator</strong>（公钥验证策略）app端只会对服务器返回的证书和本地保存的证书中的 PublicKey(公钥)进行校验，所以当证书需要更新时，只需确保公钥保持不变，不需要更新App。</p>
</li>
<li><p><strong>CompositeTrustEvaluator</strong>（自定义组合验证策略）以上多种策略组合一起，只有在所有数组中值都成功时才成功。</p>
</li>
<li><p><strong>DisabledTrustEvalutor</strong>（不验验证策略）无条件信任，所有都可以通过验证。正式环境不建议用此策略，多用于测试。</p>
</li>
</ol>
</blockquote>
<p><strong>我们用的是PublicKeysTrustEvaluator（公钥验证策略）</strong></p>
<hr>
<blockquote>
<p>后台提供证书，将正式放在项目目录中。</p>
</blockquote>
<p><img src="https://i-blog.csdnimg.cn/blog_migrate/d2b909e2935eccedbf88e97df824ecf9.png" alt="本地证书存放"></p>
<blockquote>
<p>获取本地证书，提取证书的公钥（获取公钥key数组）。证书后缀名一般有：.cer、.crt、.der等，我项目中用的cer，证书链必须包含一个固定的公钥。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct WTCertificates &#123;</span><br><span class="line">    static let rootCA = WTCertificates.certificate( )</span><br><span class="line">    static func certificate() -&gt; [SecKey] &#123;</span><br><span class="line">        var publicKeyArray:[SecKey] = []</span><br><span class="line">        for resource in [&quot;xxx&quot;, &quot;xxxx&quot;, &quot;xxxxx&quot;] &#123;// 本地证书名称</span><br><span class="line">            if let filePath = Bundle.main.path(forResource: resource, ofType: &quot;cer&quot;), let data = try? Data(contentsOf: URL(fileURLWithPath: filePath)) as CFData, let certificate = SecCertificateCreateWithData(nil, data),let publicKey = certificate.af.publicKey &#123;</span><br><span class="line">                publicKeyArray.append(publicKey)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return publicKeyArray</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>给Session添加策略（接受质询）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var requestManagerSession: Session = &#123;</span><br><span class="line">    if WTCertificates.rootCA.count &gt; 0, verifyCert &#123;</span><br><span class="line">        let certificates: [SecKey] = WTCertificates.rootCA</span><br><span class="line">        let trustPolicy = PublicKeysTrustEvaluator(keys: certificates, performDefaultValidation: false, validateHost: false)</span><br><span class="line">        let manager = ServerTrustManager(evaluators: [</span><br><span class="line">            &quot;xxx.xxx.com&quot;: trustPolicy,</span><br><span class="line">            &quot;xx.xx.jftplus.com&quot;: trustPolicy,</span><br><span class="line">            &quot;xxx.xx.com&quot;: trustPolicy])// base url 如何域名过多，可以子类化 ServerTrustManager，并用自己的自定义实现重写 serverTrustEvaluator(forHost:) 方法</span><br><span class="line">        let configuration = URLSessionConfiguration.af.default</span><br><span class="line">        return Session(configuration: configuration, serverTrustManager: manager)</span><br><span class="line">    &#125;</span><br><span class="line">    return MoyaProvider&lt;ApiManager&gt;.defaultAlamofireSession()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在Moya中添加requestManagerSession</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var JKOtherApiManagerProvider = MoyaProvider&lt;JKOtherApiManager&gt;(endpointClosure: endpointMapping, requestClosure: requestTimeoutClosure, session:requestManagerSession, plugins:[RequestAlertPlugin(), networkPlugin])</span><br></pre></td></tr></table></figure>
<h2 id="OC-HTTPS-证书配置验证"><a href="#OC-HTTPS-证书配置验证" class="headerlink" title="OC HTTPS 证书配置验证"></a>OC HTTPS 证书配置验证</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//1 将证书拖进项目</span><br><span class="line"></span><br><span class="line">//2 获取证书路径</span><br><span class="line">NSString *certPath = [[NSBundle mainBundle] pathForResource: @&quot;cetus&quot; ofType:@&quot;cer&quot;];</span><br><span class="line">//3 获取证书data</span><br><span class="line">NSData *certData = [NSData dataWithContentsOfFile:certPath];</span><br><span class="line">//4 创建AFN 中的securityPolicy</span><br><span class="line">AFSecurityPolicy *securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModePublicKey withPinnedCertificates:[[NSSet alloc] initWithObjects:certData,nil]];</span><br><span class="line">//5 这里就可以添加多个server证书</span><br><span class="line">NSSet *dataSet = [[NSSet alloc]initWithObjects:certData, nil];</span><br><span class="line">//6 绑定证书（不止一个证书）</span><br><span class="line">[securityPolicy setPinnedCertificates:dataSet];</span><br><span class="line">//7 是否允许无效证书</span><br><span class="line">securityPolicy.allowInvalidCertificates = YES;</span><br><span class="line">//8 是否需要验证域名</span><br><span class="line">securityPolicy.validatesDomainName = YES;</span><br><span class="line">uploadManager.securityPolicy = securityPolicy;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们后台给的证书格式后缀是.pem，以下是用OpenSSL命令将.pem证书转换为cer格式证书方法</p>
</blockquote>
<ol>
<li>打开命令行工具，进入存放xxx.pem证书的目录</li>
<li>输入以下命令，将.pem证书转换为cer格式<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in xxx.pem -inform PEM -out xxx.cer -outform DER</span><br></pre></td></tr></table></figure></li>
<li>执行完毕后，您将在当前目录下看到生成的xxx.cer文件</li>
</ol>
<blockquote>
<p><strong>注意：转换后的cer证书文件只包含公钥，不包含私钥信息</strong></p>
</blockquote>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CSSL%E2%80%9D/" rel="tag">“SSL”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9Cswift%E2%80%9D/" rel="tag">“swift”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9C%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81%E2%80%9D/" rel="tag">“证书验证”</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-项目剖析03-swift-网络请求Moya-HandyJSON-RxSwift"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/12/23/%E9%A1%B9%E7%9B%AE%E5%89%96%E6%9E%9003-swift-%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82Moya-HandyJSON-RxSwift/"
    >项目剖析03-swift 网络请求Moya+HandyJSON+RxSwift</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2019/12/23/%E9%A1%B9%E7%9B%AE%E5%89%96%E6%9E%9003-swift-%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82Moya-HandyJSON-RxSwift/" class="article-date">
  <time datetime="2019-12-23T08:39:52.000Z" itemprop="datePublished">2019-12-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/swift/">swift</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p>项目第一版网络框架用的是<a target="_blank" rel="noopener" href="https://github.com/bustoutsolutions/siesta">siesta</a>,它的缓存与自动刷新确实很好用而且代码很简洁，但是在文件的上传与下载以及对返回类型需要精确匹配要求这方面就很不友好，所以在第二版的我选择了<a target="_blank" rel="noopener" href="https://github.com/Moya/Moya">Moya</a>,它是一个网络抽象层，它在<a target="_blank" rel="noopener" href="https://github.com/Alamofire/Alamofire">Alamofire</a>基础上提供了一系列的抽象接口方便维护。关于<code>Moya</code>的使用介绍很多，我就不再赘述了。我主要记录一下我在使用过程中学到的处理方式。我的网络框架是搭着<a target="_blank" rel="noopener" href="https://github.com/alibaba/HandyJSON">HandyJSON</a>和<a target="_blank" rel="noopener" href="https://github.com/Moya/Moya/blob/master/docs/RxSwift.md">RxSwift</a>一起构建的。</p>
</blockquote>
<h3 id="Moya"><a href="#Moya" class="headerlink" title="Moya"></a>Moya</h3><p><strong>代码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">import Foundation</span><br><span class="line">import enum Result.Result</span><br><span class="line">import Alamofire</span><br><span class="line"></span><br><span class="line">//设置请求超时时间</span><br><span class="line">private let requestTimeoutClosure = &#123; (endpoint: Endpoint, done: @escaping MoyaProvider&lt;ApiManager&gt;.RequestResultClosure) in</span><br><span class="line">    do &#123;</span><br><span class="line">        var request = try endpoint.urlRequest()</span><br><span class="line">        request.timeoutInterval = 60</span><br><span class="line">        done(.success(request))</span><br><span class="line">    &#125; catch &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">let ApiManagerProvider = MoyaProvider&lt;ApiManager&gt;(endpointClosure: endpointMapping, requestClosure: requestTimeoutClosure, plugins:[])</span><br><span class="line"></span><br><span class="line">// MARK: 取消所有请求</span><br><span class="line">func cancelAllRequest() &#123;</span><br><span class="line">    WTOtherProvider.manager.session.getTasksWithCompletionHandler &#123; dataTasks, uploadTasks, downloadTasks in</span><br><span class="line">        dataTasks.forEach &#123; $0.cancel() &#125;</span><br><span class="line">        uploadTasks.forEach &#123; $0.cancel() &#125;</span><br><span class="line">        downloadTasks.forEach &#123; $0.cancel() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    WTLoginProvider.manager.session.getTasksWithCompletionHandler &#123; dataTasks, uploadTasks, downloadTasks in</span><br><span class="line">        dataTasks.forEach &#123; $0.cancel() &#125;</span><br><span class="line">        uploadTasks.forEach &#123; $0.cancel() &#125;</span><br><span class="line">        downloadTasks.forEach &#123; $0.cancel() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ……</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">public func endpointMapping&lt;Target: TargetType&gt;(target: Target) -&gt; Endpoint &#123;</span><br><span class="line">    WTDLog(&quot;请求连接：\(target.baseURL)\(target.path) \n方法：\(target.method)\n参数：\(String(describing: target.task.self)) &quot;)</span><br><span class="line">    return MoyaProvider.defaultEndpointMapping(for: target)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">final class RequestAlertPlugin: PluginType &#123;</span><br><span class="line">    </span><br><span class="line">    func prepare(_ request: URLRequest, target: TargetType) -&gt; URLRequest &#123;</span><br><span class="line">        return request</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func willSend(_ request: RequestType, target: TargetType) &#123;</span><br><span class="line">        //实现发送请求前需要做的事情</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public func didReceive(_ result: Result&lt;Response, MoyaError&gt;, target: TargetType) &#123;</span><br><span class="line"></span><br><span class="line">        switch result &#123;</span><br><span class="line">        case .success(let response):</span><br><span class="line">            guard response.statusCode == 200 else &#123;</span><br><span class="line">                if response.statusCode == 401 &#123;</span><br><span class="line">                    if isJumpLogin == false &#123;</span><br><span class="line">                        cancelAllRequest()</span><br><span class="line">                        // 退出登录</span><br><span class="line">                        if let nvc = (WTNavigationManger.Nav as? WTMainViewController) &#123;</span><br><span class="line">                            nvc.login()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">            var json = try? JSON(data: response.data)</span><br><span class="line">            WTDLog(&quot;请求状态码\(json?[&quot;status&quot;] ?? &quot;&quot;)&quot;)</span><br><span class="line">            </span><br><span class="line">            guard let codeString = json?[&quot;status&quot;] else &#123;return&#125;</span><br><span class="line">             if codeString == 401 &#123;// 退出登录</span><br><span class="line">                if isJumpLogin == false &#123;</span><br><span class="line">                    cancelAllRequest()</span><br><span class="line">                    if let nvc = (WTNavigationManger.Nav as? WTMainViewController) &#123;</span><br><span class="line">                        nvc.login()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        case .failure(let error):</span><br><span class="line">            WTDLog(error)</span><br><span class="line">            let myAppdelegate = UIApplication.shared.delegate as! AppDelegate</span><br><span class="line">            myAppdelegate.listenNetwork()</span><br><span class="line">            break</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct AuthPlugin: PluginType &#123;</span><br><span class="line">    let token: String</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enum ApiManager &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extension ApiManager: TargetType &#123;</span><br><span class="line">    var headers: [String : String]? &#123;</span><br><span class="line">        var dict = [&quot;ColaLanguage&quot;: (&quot;common.isChinese&quot;.L() == &quot;YES&quot;) ? &quot;CN&quot; : &quot;EN&quot;]</span><br><span class="line">        if let authToken =  WTLoginInfoManger.shareDataSingle.model?.accessToken &#123;</span><br><span class="line">            dict[&quot;Authorization&quot;] = authToken</span><br><span class="line">        &#125;</span><br><span class="line">        return dict</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var baseURL: URL &#123;</span><br><span class="line">        return URL.init(string: AppURLHOST.MyPublicBaseURL)!</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var path: String &#123;</span><br><span class="line">        return &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var method: Moya.Method &#123;</span><br><span class="line">        return .get</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var task: Task &#123;</span><br><span class="line">        return .requestPlain</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var validate: Bool &#123;</span><br><span class="line">        return false</span><br><span class="line">    &#125;</span><br><span class="line">    var sampleData: Data &#123;</span><br><span class="line">        return &quot;&quot;.data(using: String.Encoding.utf8)!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/// 数据 转 模型</span><br><span class="line">extension ObservableType where E == Response &#123;</span><br><span class="line">    public func mapHandyJsonModel&lt;T: HandyJSON&gt;(_ type: T.Type) -&gt; Observable&lt;T&gt; &#123;</span><br><span class="line">        return flatMap &#123; response -&gt; Observable&lt;T&gt; in</span><br><span class="line">            return Observable.just(response.mapHandyJsonModel(T.self))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/// 数据 转 模型</span><br><span class="line">extension Response &#123;</span><br><span class="line">    func mapHandyJsonModel&lt;T: HandyJSON&gt;(_ type: T.Type) -&gt; T &#123;</span><br><span class="line">        let jsonString = String.init(data: data, encoding: .utf8)</span><br><span class="line">        if let modelT = JSONDeserializer&lt;T&gt;.deserializeFrom(json: jsonString) &#123;</span><br><span class="line">            return modelT</span><br><span class="line">        &#125;</span><br><span class="line">        return JSONDeserializer&lt;T&gt;.deserializeFrom(json: &quot;&#123;\&quot;msg\&quot;:\&quot;\(&quot;common.try&quot;.L())\&quot;&#125;&quot;)!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// 自定义插件</span><br><span class="line">public final class NetworkLoadingPlugin: PluginType &#123;</span><br><span class="line">    public func willSend(_ request: RequestType, target: TargetType) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public func didReceive(_ result: Result&lt;Moya.Response, MoyaError&gt;, target: TargetType) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>模式Target -&gt; Endpoint -&gt; Request</strong></p>
<p><img src="https://i-blog.csdnimg.cn/blog_migrate/24422c24f3f5cf628f45d967e4ec09c9.png" alt="来自GitHub图片"></p>
<blockquote>
<p><code>Moya</code>虽然是基于Alamofire的但是我们在代码中却不会和Alamofire打交道，它是通过枚举来管理API的。我在项目中定义来一个API基类，然后为每一个模块定义了一个API管理类。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enum HomeApiManager &#123;</span><br><span class="line">    case getBanner // 获取轮播</span><br><span class="line">    case getAnnouncement(per_page: String) // 获取公告</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>对于请求类型的改变和对于URL的改变也是通过枚举</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var method: Moya.Method &#123;</span><br><span class="line">        switch self &#123;</span><br><span class="line">        case .orderCreate:</span><br><span class="line">            return .post</span><br><span class="line">        case .orderCancelById, .orderCancelByPair:</span><br><span class="line">            return .delete</span><br><span class="line">        default:</span><br><span class="line">            return .get</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">var path: String &#123;</span><br><span class="line">        switch self &#123;</span><br><span class="line">        case .getKline:</span><br><span class="line">            return &quot;/api/kline&quot;</span><br><span class="line">        case .transGetByID(let orderId):</span><br><span class="line">            return &quot;/api/\(orderId)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>请求任务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">var task: Task &#123;</span><br><span class="line">    switch self &#123;</span><br><span class="line">    case .securityPostGoogleAuth(let tokenKey, let oldGoogleCode, let googleCode, let captcha):</span><br><span class="line">        return .requestParameters(parameters: [&quot;captcha&quot;: captcha], encoding: JSONEncoding.default) // post请求</span><br><span class="line"></span><br><span class="line">    case .getReward(let type, let cursor, let limit):</span><br><span class="line">        return .requestParameters(parameters: [&quot;type&quot;: type], encoding: URLEncoding.default) // 其它请求</span><br><span class="line"></span><br><span class="line">    case .uploadImage(let imageArry):</span><br><span class="line">        let formDataAry:NSMutableArray = NSMutableArray()</span><br><span class="line">        for (index,image) in imageArry.enumerated() &#123;</span><br><span class="line">            //图片转成Data</span><br><span class="line">            let data:Data = image.jpegData(compressionQuality: 0.7)!</span><br><span class="line">            //根据当前时间设置图片上传时候的名字</span><br><span class="line">            var dateStr: String = &quot;yyyy-MM-dd-HH:mm:ss&quot;.timeStampToString(timeStamp: Date().timeIntervalSince1970)</span><br><span class="line">            //别忘记这里给名字加上图片的后缀哦</span><br><span class="line">            dateStr = dateStr.appendingFormat(&quot;-%i.jpg&quot;, index)</span><br><span class="line">            let formData = MultipartFormData(provider: .data(data), name: &quot;file\(index)&quot;, fileName: dateStr, mimeType: &quot;image/jpeg&quot;)</span><br><span class="line">            formDataAry.add(formData)</span><br><span class="line">        &#125;</span><br><span class="line">        return .uploadCompositeMultipart(formDataAry as! [MultipartFormData], urlParameters: [</span><br><span class="line">            :])</span><br><span class="line">        </span><br><span class="line">    default:</span><br><span class="line">        return .requestPlain</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="插件机制"><a href="#插件机制" class="headerlink" title="插件机制"></a>插件机制</h3><blockquote>
<p><code>Moya</code>的另一个强大的功能就是它的插件机制，提供了两个接口，willSendRequest 和 didReceiveResponse，它可以在请求前和请求后做一些额外的操作而和主功能是解耦的，比如可以在请求前开始加载动画请求结束后移除加载动画，还可以自定义插件。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">final class RequestAlertPlugin: PluginType &#123;</span><br><span class="line">    func prepare(_ request: URLRequest, target: TargetType) -&gt; URLRequest &#123;</span><br><span class="line">        return request</span><br><span class="line">    &#125;</span><br><span class="line">    func willSend(_ request: RequestType, target: TargetType) &#123;</span><br><span class="line">        现发送请求前需要做的事情</span><br><span class="line">        if target.headers?[&quot;isHiddentLoading&quot;] != &quot;true&quot; &#123;</span><br><span class="line">            currentView?.addSubview(activityIndicatorView)</span><br><span class="line">            activityIndicatorView.center = currentView!.center</span><br><span class="line">            activityIndicatorView.startAnimating()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public func didReceive(_ result: Result&lt;Response, MoyaError&gt;, target: TargetType) &#123;</span><br><span class="line">        if activityIndicatorView.isAnimating &#123;</span><br><span class="line">            activityIndicatorView.stopAnimating()</span><br><span class="line">            activityIndicatorView.removeFromSuperview()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// 自定义插件</span><br><span class="line">public final class NetworkLoadingPlugin: PluginType &#123;</span><br><span class="line">    public func willSend(_ request: RequestType, target: TargetType) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public func didReceive(_ result: Result&lt;Moya.Response, MoyaError&gt;, target: TargetType) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Moya默认有4个插件</p>
<ol>
<li><p>AccessTokenPlugin    &#x2F;&#x2F; 管理AccessToken的插件</p>
</li>
<li><p>CredentialsPlugin       &#x2F;&#x2F; 管理认证的插件</p>
</li>
<li><p>NetworkActivityPlugin &#x2F;&#x2F; 管理网络状态的插件</p>
</li>
<li><p>NetworkLoggerPlugin &#x2F;&#x2F; 管理网络log的插件</p>
</li>
</ol>
</blockquote>
<h3 id="RxSwift"><a href="#RxSwift" class="headerlink" title="RxSwift"></a>RxSwift</h3><blockquote>
<p>这里的RxSwift不是完整的RxSwift，而是为Moya定制的一个扩展(pod ‘Moya&#x2F;RxSwift’)在数据请求回来后进行处理。</p>
<ol>
<li><p>request()  传入API</p>
</li>
<li><p>asObservable() 是Moya为RxSwift提供的扩展方法，返回可监听序列</p>
</li>
<li><p>mapHandyJsonModel() 也是Moya RxSwift的扩展方法进行自定义的，可以把返回的数据解析成model</p>
</li>
<li><p>subscribe() 是对处理过的 Observable 订阅一个 onNext 的观察者，一旦得到JSON格式的数据，就会经行相应的处理</p>
</li>
<li><p>disposed() 是RxSwift的一个自动内存处理机制，类似ARC，会自动处理不需要的对象</p>
</li>
</ol>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">/// 数据 转 模型</span><br><span class="line">extension ObservableType where E == Response &#123;</span><br><span class="line">    public func mapHandyJsonModel&lt;T: HandyJSON&gt;(_ type: T.Type) -&gt; Observable&lt;T&gt; &#123;</span><br><span class="line">        return flatMap &#123; response -&gt; Observable&lt;T&gt; in</span><br><span class="line">            return Observable.just(response.mapHandyJsonModel(T.self))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/// 数据 转 模型</span><br><span class="line">extension Response &#123;</span><br><span class="line">    func mapHandyJsonModel&lt;T: HandyJSON&gt;(_ type: T.Type) -&gt; T &#123;</span><br><span class="line">        let jsonString = String.init(data: data, encoding: .utf8)</span><br><span class="line">        if let modelT = JSONDeserializer&lt;T&gt;.deserializeFrom(json: jsonString) &#123;</span><br><span class="line">            return modelT</span><br><span class="line">        &#125;</span><br><span class="line">        return JSONDeserializer&lt;T&gt;.deserializeFrom(json: &quot;&#123;\&quot;msg\&quot;:\&quot;\(&quot;common.try&quot;.L())\&quot;&#125;&quot;)!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">extension WTApiManager &#123;</span><br><span class="line">    class func NetExchangeRequest&lt;T: BaseModel&gt;(disposeBag: DisposeBag,type: ExchangeApiManager, model: T.Type, isBackFail: Bool = false, Success:@escaping (T)-&gt;(), Error: @escaping ()-&gt;()) &#123;</span><br><span class="line">        WTExchangeProvider.rx.request(type)</span><br><span class="line">            .asObservable()</span><br><span class="line">            .mapHandyJsonModel(model)</span><br><span class="line">            .subscribe &#123; (event) in</span><br><span class="line">                switch event &#123;</span><br><span class="line">                case let .next(data):</span><br><span class="line">                    if isBackFail &#123;</span><br><span class="line">                        Success(data)</span><br><span class="line">                        break</span><br><span class="line">                    &#125;</span><br><span class="line">                    guard data.status == 200 else &#123;</span><br><span class="line">                        WTProgressHUD.show(error: data.message ?? &quot;common.try&quot;.L(), toView: nil)</span><br><span class="line">                        Error()</span><br><span class="line">                        break</span><br><span class="line">                    &#125;</span><br><span class="line">                    Success(data)</span><br><span class="line">                    break</span><br><span class="line">                case let .error(error):</span><br><span class="line">                    WTDLog(error)</span><br><span class="line">                    Error()</span><br><span class="line">                    break</span><br><span class="line">                default:</span><br><span class="line">                    break</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;.disposed(by: disposeBag)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HandyJSON"><a href="#HandyJSON" class="headerlink" title="HandyJSON"></a>HandyJSON</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class BaseModel: HandyJSON &#123;</span><br><span class="line">    var status: Int = 0</span><br><span class="line">    var message: String? = nil // 服务端返回提示</span><br><span class="line">    required init()&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class WTBaseModel&lt;T: HandyJSON&gt;: BaseModel &#123;</span><br><span class="line">    var data: T? // 具体的data的格式和业务相关，故用泛型定义</span><br><span class="line">&#125;</span><br><span class="line">struct WTCurrencyBalanceModel: HandyJSON &#123;</span><br><span class="line">    var coinCode: String = &quot;&quot;</span><br><span class="line">    let balanceAvailable: Double = 0.0</span><br><span class="line">    let balanceFrozen: Double = 0.0</span><br><span class="line">    let worth: Double = 0.0</span><br><span class="line">&#125;</span><br><span class="line">// 网络请求 传入对应model</span><br><span class="line">WTApiManager.NetOtherRequest(disposeBag: disposeBag, type: .getMarketsPrice, model: WTBaseModel&lt;WTRateModel&gt;, Success: &#123;(model) in</span><br><span class="line">&#125;) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="以上就是我在项目中使用"><a href="#以上就是我在项目中使用" class="headerlink" title="以上就是我在项目中使用"></a>以上就是我在项目中使用</h3><p><strong><code>Moya+HandyJSON+RxSwift</code>的方法，如果有错误或者不足之处还望指正，谢谢</strong></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CHandyJSON%E2%80%9D/" rel="tag">“HandyJSON”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CMoya%E2%80%9D/" rel="tag">“Moya”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CRxSwift%E2%80%9D/" rel="tag">“RxSwift”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9Cswift%E2%80%9D/" rel="tag">“swift”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9C%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E2%80%9D/" rel="tag">“网络请求”</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-项目剖析02-swift-轻松实现动画效果-Lottie"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/12/23/%E9%A1%B9%E7%9B%AE%E5%89%96%E6%9E%9002-swift-%E8%BD%BB%E6%9D%BE%E5%AE%9E%E7%8E%B0%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C-Lottie/"
    >项目剖析02-swift 轻松实现动画效果-Lottie</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2019/12/23/%E9%A1%B9%E7%9B%AE%E5%89%96%E6%9E%9002-swift-%E8%BD%BB%E6%9D%BE%E5%AE%9E%E7%8E%B0%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C-Lottie/" class="article-date">
  <time datetime="2019-12-23T04:34:37.000Z" itemprop="datePublished">2019-12-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/airbnb/lottie-ios">Lottie</a> 是 <a target="_blank" rel="noopener" href="https://lottiefiles.com/?lang=zh_CN">Airbnb</a>开源的一套跨平台的动画效果解决方案,它能够同时支持<code>iOS</code>、<code>Android</code>、<code>Web</code> 和 <code>React Native</code>的开发，设计师只需要用 <a target="_blank" rel="noopener" href="https://www.adobe.com/cn/products/aftereffects.html">AdobeAfterEffects</a>(AE) 设计出需要的的动画之后，使用 <code>Lottie</code> 提供的 <a target="_blank" rel="noopener" href="https://github.com/bodymovin/bodymovin">Bodymovin</a> 插件将设计好的动画导出成JSON格式(文件很小不会象GIF那么庞大)给你即可，可以让设计师实现所见即所得的动画再也不用和设计师争论动画设计了。本文只是展示在swift中如何简单使用<code>Lottie</code> ，详细的使用方法请参考<a target="_blank" rel="noopener" href="https://airbnb.io/lottie/#/">官方文档</a></p>
</blockquote>
<p><img src="https://i-blog.csdnimg.cn/blog_migrate/9435d33b4f8d95e2fbaed37fa0c418ba.gif" alt="github例图"></p>
<h3 id="用法举例"><a href="#用法举例" class="headerlink" title="用法举例"></a>用法举例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">lazy var lottieAnimationView: AnimationView = &#123;</span><br><span class="line">        // 加载本地资源</span><br><span class="line">        let path : String = Bundle.main.path(forResource: &quot;data&quot;, ofType: &quot;json&quot;)!</span><br><span class="line">        let lottieAnimationView = AnimationView.init(filePath: path)</span><br><span class="line">        WTNavigationManger.Nav?.view.addSubview(lottieAnimationView)</span><br><span class="line">        lottieAnimationView.constrain(toSuperviewEdges: nil)</span><br><span class="line">        lottieAnimationView.isUserInteractionEnabled = true</span><br><span class="line">        lottieAnimationView.addGestureRecognizer(UITapGestureRecognizer(target: self, action: #selector(removeLottieAnimationViewFromParent)))</span><br><span class="line">        return lottieAnimationView</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">// 调用</span><br><span class="line">lottieAnimationView.play &#123;[weak self] (complete) in</span><br><span class="line">       guard let mySelf = self else &#123;return&#125;</span><br><span class="line">       mySelf.removeLottieAnimationViewFromParent()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">@objc func removeLottieAnimationViewFromParent() &#123;</span><br><span class="line">        lottieAnimationView.removeFromSuperview()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>将设计师给你的文件导入项目，然后通过Bundle.main.path(forResource:找到json文件，然后将AnimationView添加到视图，在需要展示动画的地方调用play() 方法，这样动画就可以加载了。</p>
</blockquote>
<h3 id="引入json的方式"><a href="#引入json的方式" class="headerlink" title="引入json的方式"></a>引入json的方式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/// json所在的文件，默认为Bundle.main</span><br><span class="line">let animation = Animation.named(&quot;StarAnimation&quot;) </span><br><span class="line">/// 默认为Bundle.main</span><br><span class="line">let animation = Animation.named(&quot;StarAnimation&quot;, bundle: myBundle)</span><br><span class="line">/// subdirectory 为动画所在的包中的子目录(可选的)</span><br><span class="line">let animation = Animation.named(&quot;StarAnimation&quot;, subdirectory: &quot;Animations&quot;)</span><br><span class="line">/// animationCache 为保存加载动画的缓存(可选的)</span><br><span class="line">let animation = Animation.named(&quot;StarAnimation&quot;, animationCache: LRUAnimationCache.sharedCache)</span><br></pre></td></tr></table></figure>

<h3 id="指定加载路径"><a href="#指定加载路径" class="headerlink" title="指定加载路径"></a>指定加载路径</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Animation.filepath(_ filepath: String, animationCache: AnimationCacheProvider?) -&gt; Animation?</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从绝对文件路径加载动画模型。如果没有找到动画，则返回nil<br>filepath:要加载的动画的绝对文件路径<br>animationCache:用于保存加载的动画的缓存(可选的)</p>
</blockquote>
<h3 id="播放动画"><a href="#播放动画" class="headerlink" title="播放动画"></a>播放动画</h3><p><strong>基本播放(Basic Playing)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 播放动画从它的当前状态到它的时间轴结束。在动画停止时调用completion代码块</span><br><span class="line">// 如果动画完成，则completion返回true。如果动画被中断，则返回false</span><br><span class="line">AnimationView.play(completion: LottieCompletionBlock?)</span><br></pre></td></tr></table></figure>
<p><strong>利用进度时间(Play with Progress Time)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 指定一个时间到另一个时间的播放</span><br><span class="line">AnimationView.play(fromProgress: AnimationProgressTime?, toProgress: AnimationProgressTime, loopMode: LottieLoopMode?, completion: LottieCompletionBlock?)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>时间帧播放(Play with Marker Names)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 动画播放从一个时间帧到另一个时间帧</span><br><span class="line">AnimationView.play(fromFrame: AnimationProgressTime?, toFrame: AnimationFrameTime, loopMode: LottieLoopMode?, completion: LottieCompletionBlock?)</span><br></pre></td></tr></table></figure>
<p><strong>时间帧播放(Play with Marker Names)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 将动画从命名标记播放到另一个标记。标记是编码到动画数据中并指定名称的时间点</span><br><span class="line">AnimationView.play(fromMarker: String?, toMarker: String, loopMode: LottieLoopMode?, completion: LottieCompletionBlock?)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="其它操作"><a href="#其它操作" class="headerlink" title="其它操作"></a>其它操作</h3><blockquote>
<ol>
<li><p>AnimationView.pause() &#x2F;&#x2F; 暂停</p>
</li>
<li><p>AnimationView.stop()  &#x2F;&#x2F; 停止</p>
</li>
<li><p>var AnimationView.backgroundBehavior: LottieBackgroundBehavior { get set} &#x2F;&#x2F; app进入后台</p>
</li>
<li><p>var AnimationView.contentMode: UIViewContentMode { get set } &#x2F;&#x2F; 循环播放模式。默认是playOnce，还有autoReverse无限循环</p>
</li>
<li><p>var AnimationView.isAnimationPlaying: Bool { get set } &#x2F;&#x2F; 判断动画是否在播放</p>
</li>
<li><p>var AnimationView.animationSpeed: CGFloat { get set } &#x2F;&#x2F; 动画速度</p>
</li>
<li><p>func AnimationView.forceDisplayUpdate() &#x2F;&#x2F; 强制重绘动画视图</p>
</li>
</ol>
</blockquote>
<p><strong>以上就是我在项目中使用<code>Lottie</code>的方法，如果有错误或者不足之处还望指正，谢谢</strong></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CLottie%E2%80%9D/" rel="tag">“Lottie”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CiOS%E2%80%9D/" rel="tag">“iOS”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9C%E5%8A%A8%E7%94%BB%E2%80%9D/" rel="tag">“动画”</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="[layout]-项目剖析01-swift-WebSocket"
  class="article article-type-[layout]"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/12/23/%E9%A1%B9%E7%9B%AE%E5%89%96%E6%9E%9001-swift-WebSocket/"
    >项目剖析01-swift WebSocket</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2019/12/23/%E9%A1%B9%E7%9B%AE%E5%89%96%E6%9E%9001-swift-WebSocket/" class="article-date">
  <time datetime="2019-12-23T02:00:16.000Z" itemprop="datePublished">2019-12-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/swift/">swift</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <blockquote>
<p>已经很长一段时间没有总结项目了，正好最近完成项目第二版的改版(新项目完全是用swift写的)，就把项目中一些有意义的知识块在此记录一下， 项目中有实时的交易需要展示，所以用到了socket长链接，我用的是<a target="_blank" rel="noopener" href="https://github.com/daltoniam/Starscream">Starscream</a>这个第三方库，集成方法很简单去网站看看就知道。</p>
</blockquote>
<h3 id="先上代码"><a href="#先上代码" class="headerlink" title="先上代码"></a>先上代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">import UIKit</span><br><span class="line">import Reachability</span><br><span class="line">import Starscream</span><br><span class="line">import zlib</span><br><span class="line"></span><br><span class="line">let reachability = Reachability()! // 判断网络连接</span><br><span class="line">let webSocket = WTWebsocket.shared</span><br><span class="line">var reConnectTime = 0 // 设置重连次数</span><br><span class="line">let reConnectMaxTime = 1000 // 设置最大重连次数</span><br><span class="line">let reConnectIntervalTime: TimeInterval = 15 // 设置重连时间间隔(秒)</span><br><span class="line">var websocketTimer: Timer? = nil</span><br><span class="line">var reConnectSubscribeDict:[String : Any] = [:]</span><br><span class="line">var page = &quot;home&quot;</span><br><span class="line">var isReconnect = true</span><br><span class="line"></span><br><span class="line">final class WTWebsocket: NSObject,WebSocketDelegate &#123;</span><br><span class="line">    </span><br><span class="line">    var isPingBack = true</span><br><span class="line">    var myWebsocket: WebSocket? = nil</span><br><span class="line">    //  socket连接上函数</span><br><span class="line">    func websocketDidConnect(socket: WebSocketClient) &#123;</span><br><span class="line">        //设置重连次数，解决无限重连问题</span><br><span class="line">        reConnectTime = 0</span><br><span class="line">        if reConnectSubscribeDict.count &gt; 0 &#123;</span><br><span class="line">            self.subscribe(subscribeDict: reConnectSubscribeDict)</span><br><span class="line">        &#125;</span><br><span class="line">        self.hearJump()</span><br><span class="line">        if  websocketTimer == nil &#123;</span><br><span class="line">            websocketTimer = Timer.scheduledTimer(timeInterval: reConnectIntervalTime, target: self, selector: #selector(sendBrandStr), userInfo: nil, repeats: true)</span><br><span class="line">        &#125;</span><br><span class="line">        isReconnect = true</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //发送文字消息</span><br><span class="line">    @objc func sendBrandStr()&#123;</span><br><span class="line">        self.checkPing()</span><br><span class="line">        let json = getJSONStringFromDictionary(dictionary: [&quot;topic&quot;:&quot;PING&quot;])</span><br><span class="line">        SingletonSocket.sharedInstance.socket.write(string: json)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 发送ping</span><br><span class="line">    func hearJump() &#123;</span><br><span class="line">        let json = getJSONStringFromDictionary(dictionary: [&quot;topic&quot;:&quot;PING&quot;])</span><br><span class="line">        SingletonSocket.sharedInstance.socket.write(string: json)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //  socket断开执行函数</span><br><span class="line">    func websocketDidDisconnect(socket: WebSocketClient, error: Error?) &#123;</span><br><span class="line">        //执行重新连接方法</span><br><span class="line">        socketReconnect()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //  接收返回消息函数</span><br><span class="line">    func websocketDidReceiveMessage(socket: WebSocketClient, text: String) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func websocketDidReceiveData(socket: WebSocketClient, data: Data) &#123;</span><br><span class="line">        guard let newStr = String(data: data.gzipUncompress(), encoding: .utf8) else &#123;return&#125;</span><br><span class="line">        if newStr == &quot;PONG&quot; &#123;</span><br><span class="line">            isPingBack = true</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">      // 处理收到的信息</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 添加注册</span><br><span class="line">    func subscribe(subscribeDict: [String : Any]) &#123;</span><br><span class="line">        var subscribeDicts = subscribeDict</span><br><span class="line">        reConnectSubscribeDict = subscribeDicts</span><br><span class="line">        page = subscribeDicts[&quot;type&quot;] as! String</span><br><span class="line">        subscribeDicts.removeValue(forKey: &quot;type&quot;)</span><br><span class="line">        let json = getJSONStringFromDictionary(dictionary:</span><br><span class="line">            subscribeDicts as NSDictionary)</span><br><span class="line">        SingletonSocket.sharedInstance.socket.write(string: json)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //检测</span><br><span class="line">    @objc func checkPing() &#123;</span><br><span class="line">        if !isPingBack &#123;</span><br><span class="line">            // 重新连接</span><br><span class="line">            socketReconnect()</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            isPingBack = false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //构造单例数据</span><br><span class="line">    static let shared = WTWebsocket()</span><br><span class="line">    private override init() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//socket 重连逻辑</span><br><span class="line">func socketReconnect() &#123;</span><br><span class="line">    //判断网络情况，如果网络正常，可以执行重连</span><br><span class="line">    if reachability.connection != .none &#123;</span><br><span class="line">        //设置重连次数，解决无限重连问题</span><br><span class="line">        reConnectTime =  reConnectTime + 1</span><br><span class="line">        if reConnectTime &lt; reConnectMaxTime &#123;</span><br><span class="line">            //添加重连延时执行，防止某个时间段，全部执行</span><br><span class="line">            let time: TimeInterval = 2.0</span><br><span class="line">            DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + time) &#123;</span><br><span class="line">                SingletonSocket.sharedInstance.socket.connect()</span><br><span class="line">                SingletonSocket.sharedInstance.socket.disconnect()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //提示重连失败</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //提示无网络</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//socket主动断开，放在app进入后台时，数据进入缓存。app再进入前台，app出现卡死的情况</span><br><span class="line">func socketDisConnect() &#123;</span><br><span class="line">    if !SingletonSocket.sharedInstance.socket.isConnected &#123;</span><br><span class="line">        websocketTimer?.invalidate()</span><br><span class="line">        websocketTimer = nil</span><br><span class="line">        SingletonSocket.sharedInstance.socket.disconnect()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// initSocket方法</span><br><span class="line">func initWebSocketSingle () &#123;</span><br><span class="line">    SingletonSocket.sharedInstance.socket.delegate = webSocket</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//声明webSocket单例</span><br><span class="line">class SingletonSocket &#123;</span><br><span class="line">    let socket:WebSocket = WebSocket(url: URL(string: AppURLHOST.SocketURL)!)</span><br><span class="line">    class var sharedInstance : SingletonSocket&#123;</span><br><span class="line">        struct Static&#123;</span><br><span class="line">            static let instance:SingletonSocket = SingletonSocket()</span><br><span class="line">        &#125;</span><br><span class="line">        if !Static.instance.socket.isConnected&#123;</span><br><span class="line">            Static.instance.socket.connect()</span><br><span class="line">        &#125;</span><br><span class="line">        return Static.instance</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="整个代码很简单，基本都有注释，大概聊一聊里面的一些关键点"><a href="#整个代码很简单，基本都有注释，大概聊一聊里面的一些关键点" class="headerlink" title="整个代码很简单，基本都有注释，大概聊一聊里面的一些关键点"></a>整个代码很简单，基本都有注释，大概聊一聊里面的一些关键点</h3><blockquote>
<p>发送ping-俗称发送心跳，这个主要是判断socket是否断开，链接成功后每次间隔固定时间发送一次请求，然后在返回中修改isPingBack，在下一次发送请求前检查isPingBack判断上一次的请求是否返回，这样就可以判断socket是否断开，这个间隔时间可以自由设定，但是最好不要太短，太短有可能是socket连接了但是没有来得及返回。当然太长也不行，这可能导致发现socket断开不及时。</p>
</blockquote>
<p><strong>app在后台需要断开socket，当 app重新进入前台需要重新连接</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">func applicationWillResignActive(_ application: UIApplication) &#123;</span><br><span class="line">        //进入后台模式，主动断开socket，防止出现处理不了的情况</span><br><span class="line">        if SingletonSocket.sharedInstance.socket.isConnected &#123;</span><br><span class="line">            reConnectTime = reConnectMaxTime</span><br><span class="line">            socketDisConnect()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    func applicationDidBecomeActive(_ application: UIApplication) &#123;</span><br><span class="line">        //进入前台模式，主动连接socket</span><br><span class="line">        //解决因为网络切换或链接不稳定问题，引起socket断连问题</span><br><span class="line">        //如果app从无网络，到回复网络，需要执行重连</span><br><span class="line">        if !isFirstApplicationDidBecomeActive &#123;</span><br><span class="line">            reConnectTime = 0</span><br><span class="line">            socketReconnect()</span><br><span class="line">            WTBasicConfigManager.shareDataSingle.getHash()</span><br><span class="line">        &#125;</span><br><span class="line">        isFirstApplicationDidBecomeActive = false</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>一定要设置最大重新连接的次数，不然app会无限重新连接</strong></p>
<p><strong>连接成功或者重连成功都需要对需要推送的数据进行一次网络请求，确保数据的准确性。</strong></p>
<blockquote>
<p>以上就是我在项目中使用WebSocket的方法，如果有错误或者不足之处还望指正，谢谢</p>
</blockquote>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9CWebSocket%E2%80%9D/" rel="tag">“WebSocket”</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E2%80%9Cswift%E2%80%9D/" rel="tag">“swift”</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2025
        <i class="ri-heart-fill heart_icon"></i> kindyourself@163.com
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Gavin&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" target="_blank" rel="noopener" href="https://www.jianshu.com/u/51707eacf496">简书</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.png">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.png">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>